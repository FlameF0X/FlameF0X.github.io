<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i3-lab | Groq Compound</title>
    <link rel="icon" type="image/x-icon" href="/assets/logo.png">
    
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: '#0c0a09', // Darker stone
                        surface: '#1c1917',
                        surface_hover: '#292524',
                        text: '#e7e5e4',
                        accent: '#ea580c', // Vibrant orange
                        'accent-dim': '#431407',
                        border: '#44403c',
                        lime: '#84cc16' 
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        :root {
            --grid-color: rgba(231, 229, 228, 0.05);
        }
        
        body {
            background-color: theme('colors.bg');
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: theme('colors.text');
        }

        /* Utilities */
        .raw-border { border: 2px solid theme('colors.border'); }
        .raw-border-focus:focus-within { border-color: theme('colors.accent'); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.stone.800'); }
        ::-webkit-scrollbar-thumb:hover { background: theme('colors.accent'); }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: theme('colors.accent');
            margin-top: -6px;
            cursor: pointer;
            border: 2px solid theme('colors.bg');
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: theme('colors.stone.800');
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: theme('colors.stone.700');
        }

        /* Glitch/Hover Effects */
        .hover-invert { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-invert:hover {
            background-color: theme('colors.text');
            color: theme('colors.bg');
            border-color: theme('colors.text');
        }
        .hover-invert:hover * { color: theme('colors.bg'); stroke: theme('colors.bg'); }

        /* Bracket Box (Corner Brackets) */
        .bracket-box { position: relative; }
        .bracket-box::before, .bracket-box::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-color: theme('colors.accent');
            border-style: solid;
            transition: all 0.2s ease;
            opacity: 0;
        }
        .bracket-box::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .bracket-box::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        
        /* Animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Model Selector Tabs */
        .model-tab {
            @apply px-3 py-1 text-[10px] font-mono font-bold uppercase tracking-widest cursor-pointer border-t border-l border-r border-transparent text-stone-600 transition-all;
        }
        .model-tab.active {
            @apply bg-surface text-accent border-stone-800 border-b-bg translate-y-[1px] z-10;
        }
        .model-tab:hover:not(.active) {
            @apply text-stone-400 bg-stone-900;
        }

        /* --- WRAPPED ANIMATIONS --- */
        .wrapped-gradient-text {
            background: linear-gradient(90deg, #ea580c 0%, #84cc16 50%, #ea580c 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: wrapped-shine 3s linear infinite;
        }
        @keyframes wrapped-shine {
            to { background-position: 200% center; }
        }
        .card-enter {
            animation: card-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes card-slide-up {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col antialiased selection:bg-accent selection:text-white overflow-hidden">

    <!-- Mobile Header -->
    <header class="md:hidden flex items-center justify-between p-4 border-b border-stone-800 bg-bg/95 backdrop-blur">
        <span class="font-black italic text-lg tracking-tighter text-accent">// i3-lab</span>
        <button onclick="SettingsUI.toggle()" class="text-stone-400 hover:text-white"><i data-lucide="settings"></i></button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="hidden md:flex flex-col w-[280px] border-r border-stone-800 bg-bg/50 backdrop-blur-sm z-20 transition-all duration-300 ease-in-out">
            <!-- Top / Hamburger -->
            <div class="p-6 pb-2">
                <button onclick="SidebarUI.toggle()" class="p-2 -ml-2 hover:bg-surface text-stone-400 hover:text-white rounded-none transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- New Chat Buttons -->
            <div class="px-4 mb-6 space-y-2 overflow-hidden">
                <!-- Standard Session -->
                <button onclick="SessionManager.createNewSession()" class="w-full flex items-center gap-3 px-4 py-3 bg-surface hover:bg-stone-800 border border-stone-700 hover:border-accent transition-all group whitespace-nowrap">
                    <i data-lucide="plus" class="w-4 h-4 text-stone-500 group-hover:text-accent shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest text-stone-300 group-hover:text-white">New_Session</span>
                </button>
            </div>

            <!-- WRAPPED BUTTON (DYNAMICALLY INJECTED) -->
            <div id="wrapped-sidebar-btn" class="hidden px-4 mb-6 transition-all">
                <button onclick="WrappedUI.open()" class="w-full flex items-center gap-3 px-4 py-2 bg-gradient-to-r from-stone-900 to-transparent border border-accent/30 hover:border-accent hover:shadow-[0_0_15px_-3px_rgba(234,88,12,0.3)] transition-all group whitespace-nowrap relative overflow-hidden">
                    <div class="absolute inset-0 bg-accent/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i data-lucide="gift" class="w-3 h-3 text-accent group-hover:scale-110 transition-transform relative z-10"></i>
                    <span id="wrapped-btn-text" class="sidebar-text font-mono text-[10px] font-bold uppercase tracking-widest text-accent relative z-10">WRAPPED</span>
                </button>
            </div>

            <!-- Recent History -->
            <div class="flex-1 overflow-y-auto px-4 space-y-1 overflow-x-hidden">
                <div class="sidebar-text font-mono text-[10px] text-stone-600 uppercase tracking-widest mb-3 mt-2 pl-2 border-l border-stone-800 flex justify-between items-center whitespace-nowrap">
                    <span>Recent_Logs</span>
                    <button onclick="SessionManager.clearAllData()" class="text-[9px] hover:text-red-500 cursor-pointer" title="Clear Local Storage">[WIPE_MEM]</button>
                </div>
                
                <div id="session-list" class="sidebar-text space-y-1">
                    <!-- Dynamic Sessions will be injected here -->
                </div>
            </div>

            <!-- FOOTER AREA -->
            <div class="mt-auto bg-bg/80 mb-6 overflow-hidden border-t border-stone-800">
                <button onclick="SettingsUI.toggle()" class="w-full flex items-center gap-3 px-4 py-4 text-stone-400 hover:text-white hover:bg-surface transition-colors whitespace-nowrap">
                    <i data-lucide="settings" class="w-4 h-4 shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest">Settings</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col relative w-full overflow-hidden">

            <!-- CHAT SCROLL AREA -->
            <div id="chat-scroll-area" class="flex-1 overflow-y-auto w-full flex flex-col items-center pt-8 pb-96">
                
                <!-- Welcome/Greeting Section -->
                <div id="welcome-section" class="w-full max-w-4xl px-4 flex flex-col gap-8 md:gap-10 mt-[10vh]">
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 mb-2">
                            <i data-lucide="terminal" class="w-8 h-8 text-accent animate-pulse-slow"></i>
                            <h1 class="text-4xl md:text-5xl font-black tracking-tighter uppercase">
                                <span class="text-transparent stroke-white" style="-webkit-text-stroke: 1px #78716c;">Hello, </span>
                                <span class="scramble text-accent" data-text="USER">GI8rcvI9d</span>
                            </h1>
                        </div>
                        <p class="font-mono text-stone-500 text-lg md:text-xl pl-11 border-l-2 border-stone-800">
                            Neural uplink ready. Groq Compound-Mini architecture online.
                        </p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pl-11">
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Generate a system architecture diagram for a neural network')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="image" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_01</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Generate Arch</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Debug this python error: IndexError: list index out of range')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="code-2" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_02</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Debug Code</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Brainstorm ideas for a new transformer architecture')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_03</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Brainstorm</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Summarize the key differences between RNNs and Transformers')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="graduation-cap" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_04</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Summarize</span>
                        </button>
                    </div>
                </div>

                <!-- Live Chat Container -->
                <div id="chat-history" class="w-full max-w-3xl flex flex-col gap-6 px-4 hidden mb-12">
                    <!-- Dynamic messages will be inserted here -->
                </div>

            </div>

            <!-- Bottom Input Area -->
            <div class="absolute bottom-0 left-0 w-full flex justify-center p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-8">
                <div class="w-full max-w-4xl relative group flex flex-col items-start">
                    
                    <!-- MODEL SELECTOR TABS -->
                    <div class="flex gap-1 ml-4 relative top-[1px] z-20">
                        <div id="tab-compound-mini" onclick="ChatUI.switchModel('compound-mini')" class="model-tab active">
                            COMPOUND-MINI
                        </div>
                    </div>

                    <!-- Text Area Container -->
                    <div id="text-input-area" class="w-full bg-surface raw-border raw-border-focus p-4 transition-all duration-300 shadow-[0_0_20px_-10px_rgba(0,0,0,1)] hover:shadow-[0_0_15px_-3px_rgba(234,88,12,0.1)] z-10">
                        <textarea 
                            id="user-input"
                            class="w-full bg-transparent border-none focus:ring-0 text-stone-200 placeholder-stone-600 resize-none font-mono text-sm md:text-base h-12 md:h-14 py-2 leading-relaxed" 
                            placeholder="Enter command..."
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); ChatUI.sendMessage(); }"
                        ></textarea>
                        
                        <div class="flex justify-between items-center mt-2 border-t border-stone-800 pt-3">
                            <div class="flex gap-2">
                                <button class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600">
                                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                                </button>
                                <button class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="hidden md:inline font-mono text-[10px] text-stone-600">ENTER TO SEND</span>
                                <button id="send-btn" onclick="ChatUI.sendMessage()" class="bg-stone-800 hover:bg-accent text-white p-2 transition-colors w-10 h-10 flex items-center justify-center">
                                    <i id="send-icon" data-lucide="arrow-right" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

             <!-- Background Decorative Text -->
             <div class="absolute bottom-4 left-4 text-[120px] font-black text-stone-900 -z-10 select-none opacity-20 pointer-events-none leading-none tracking-tighter">
                AI/SYS
            </div>

        </main>
    </div>

    <!-- Fixed Footer Status Bar -->
    <div class="fixed bottom-0 left-0 w-full bg-bg border-t border-stone-800 z-50 px-4 py-1 flex justify-between items-center text-[10px] md:text-xs font-mono uppercase tracking-widest text-stone-500">
        <div class="flex gap-4">
            <span class="text-accent flex items-center gap-2">
                <span id="status-indicator" class="w-1.5 h-1.5 bg-accent rounded-full animate-ping"></span>
                <span id="status-text">LIVE</span>
            </span>
            <span class="hidden md:inline">API: <span id="current-api-label" class="text-stone-300">GROQ/COMPOUND-MINI</span></span>
            <span class="hidden md:inline">LATENCY: <span id="latency-val">--</span>ms/token</span>
        </div>
        <div>
             UI VERSION: 3.5 // GROQ
        </div>
    </div>

    <!-- WRAPPED OVERLAY -->
    <div id="wrapped-overlay" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-xl hidden flex flex-col items-center justify-center p-4">
        <div class="absolute top-4 right-4 z-50">
            <button onclick="WrappedUI.close()" class="text-stone-500 hover:text-white p-2">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>
        
        <div class="relative w-full max-w-2xl bg-stone-950 border-2 border-stone-800 p-8 md:p-12 shadow-[0_0_100px_rgba(234,88,12,0.1)] overflow-hidden card-enter">
            <!-- Background noise -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(rgba(234, 88, 12, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(234, 88, 12, 0.1) 1px, transparent 1px); background-size: 30px 30px;"></div>
            
            <div class="relative z-10 flex flex-col items-center text-center space-y-8">
                <!-- Header -->
                <div class="space-y-2">
                    <div class="font-mono text-xs text-accent tracking-[0.5em] uppercase animate-pulse">Annual System Report</div>
                    <h1 class="text-5xl md:text-7xl font-black italic tracking-tighter wrapped-gradient-text uppercase leading-none">
                        WRAPPED<br><span id="wrapped-title-year" class="text-stone-700 stroke-text">2025</span>
                    </h1>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full mt-8">
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-accent transition-colors">
                        <i data-lucide="message-square" class="w-6 h-6 text-stone-600 group-hover:text-accent mb-2"></i>
                        <span id="wrap-total-msgs" class="text-3xl font-black text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Prompts</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-lime transition-colors">
                        <i data-lucide="cpu" class="w-6 h-6 text-stone-600 group-hover:text-lime mb-2"></i>
                        <span id="wrap-fav-model" class="text-lg font-bold text-white truncate w-full text-center">GROQ</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Top Arch</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-cyan-500 transition-colors">
                        <i data-lucide="history" class="w-6 h-6 text-stone-600 group-hover:text-cyan-500 mb-2"></i>
                        <span id="wrap-sessions" class="text-3xl font-black text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Sessions</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-purple-500 transition-colors">
                        <i data-lucide="type" class="w-6 h-6 text-stone-600 group-hover:text-purple-500 mb-2"></i>
                        <span id="wrap-words" class="text-xl font-bold text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Est. Tokens</span>
                    </div>
                </div>

                <!-- Archetype Section -->
                <div class="w-full border-t border-stone-800 pt-8">
                    <div class="text-[10px] font-mono text-stone-500 mb-2">USER ARCHETYPE DETECTED:</div>
                    <div id="wrap-archetype" class="text-3xl md:text-4xl font-bold text-white uppercase tracking-tight">
                        THE OBSERVER
                    </div>
                    <p id="wrap-archetype-desc" class="text-xs font-mono text-stone-400 mt-2 max-w-md mx-auto">
                        Your interaction patterns suggest a careful, analytical approach to neural interfacing.
                    </p>
                </div>

                <!-- Share/Close -->
                <button onclick="WrappedUI.close()" class="px-8 py-3 bg-white text-black font-black font-mono uppercase text-xs hover:bg-accent hover:text-white transition-all hover:shadow-[0_0_20px_rgba(234,88,12,0.5)] mt-4">
                    ACKNOWLEDGE REPORT
                </button>
            </div>
        </div>
    </div>


    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-bg border border-stone-700 shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col max-h-[90vh]">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-stone-800 bg-surface">
                <div class="flex items-center gap-2">
                    <i data-lucide="sliders-horizontal" class="w-4 h-4 text-accent"></i>
                    <h2 class="font-mono text-sm font-bold uppercase tracking-widest text-white">System_Configuration</h2>
                </div>
                <button onclick="SettingsUI.toggle()" class="text-stone-500 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto space-y-8">
                
                <!-- API KEY SECTION (NEW) -->
                <div class="space-y-3 bg-red-900/10 border border-red-900/30 p-4">
                    <div class="flex items-center justify-between">
                         <label class="block font-mono text-xs uppercase text-accent tracking-widest">Groq API Key (Private)</label>
                         <i data-lucide="lock" class="w-3 h-3 text-stone-500"></i>
                    </div>
                    <input type="password" id="setting-api-key" class="w-full bg-stone-950 border border-stone-800 focus:border-accent text-stone-300 font-mono text-xs p-3 outline-none" placeholder="gsk_..." onchange="SettingsUI.save()">
                    <p class="text-[10px] text-stone-500 font-mono">
                        Key is stored in your browser's LocalStorage only. Never sent to any server other than Groq.
                    </p>
                </div>

                <!-- System Prompt Section -->
                <div class="space-y-3">
                    <label class="block font-mono text-xs uppercase text-accent tracking-widest">System Prompt (Persona)</label>
                    <textarea id="setting-system-prompt" class="w-full bg-stone-900 border border-stone-800 focus:border-accent text-stone-300 font-mono text-xs p-3 h-32 resize-none outline-none" placeholder="Enter system instructions here..."></textarea>
                </div>

                <!-- Parameters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">TEMPERATURE</label>
                            <span id="val-temp" class="text-accent">1.0</span>
                        </div>
                        <input type="range" id="setting-temp" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val-temp').innerText = this.value">
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">MAX_TOKENS</label>
                            <span id="val-tokens" class="text-accent">1024</span>
                        </div>
                        <input type="range" id="setting-tokens" min="256" max="4096" step="64" value="1024" oninput="document.getElementById('val-tokens').innerText = this.value">
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-stone-800 bg-surface flex justify-between items-center">
                <button onclick="SettingsUI.reset()" class="text-[10px] font-mono text-red-900 hover:text-red-500 uppercase tracking-wider transition-colors">
                    [RESET_DEFAULTS]
                </button>
                <div class="flex gap-3">
                    <button onclick="SettingsUI.toggle()" class="px-4 py-2 font-mono text-xs text-stone-400 hover:text-white">CANCEL</button>
                    <button onclick="SettingsUI.save()" class="px-6 py-2 bg-accent text-bg font-bold font-mono text-xs hover:bg-orange-500 transition-colors">SAVE CONFIG</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // ---------------------------------------------------------
        // Sidebar Manager
        // ---------------------------------------------------------
        const SidebarUI = {
            isCollapsed: false,
            toggle: () => {
                const sidebar = document.getElementById('main-sidebar');
                const textElements = document.querySelectorAll('.sidebar-text');
                
                SidebarUI.isCollapsed = !SidebarUI.isCollapsed;
                
                if (SidebarUI.isCollapsed) {
                    sidebar.classList.remove('w-[280px]');
                    sidebar.classList.add('w-[70px]');
                    // Hide text
                    textElements.forEach(el => el.classList.add('hidden'));
                } else {
                    sidebar.classList.add('w-[280px]');
                    sidebar.classList.remove('w-[70px]');
                    // Show text
                    textElements.forEach(el => el.classList.remove('hidden'));
                }
            }
        };

        // ---------------------------------------------------------
        // Settings Manager
        // ---------------------------------------------------------
        const SettingsUI = {
            defaults: {
                apiKey: "",
                systemPrompt: "You are a helpful, cybernetically enhanced AI assistant.",
                temperature: 1.0,
                maxTokens: 1024
            },
            
            getSettings: () => {
                const stored = localStorage.getItem('flamefox_settings');
                return stored ? JSON.parse(stored) : SettingsUI.defaults;
            },

            toggle: () => {
                const modal = document.getElementById('settings-modal');
                const isHidden = modal.classList.contains('hidden');
                
                if (isHidden) {
                    // Load current settings into inputs before showing
                    const settings = SettingsUI.getSettings();
                    document.getElementById('setting-api-key').value = settings.apiKey || "";
                    document.getElementById('setting-system-prompt').value = settings.systemPrompt || "";
                    document.getElementById('setting-temp').value = settings.temperature;
                    document.getElementById('val-temp').innerText = settings.temperature;
                    document.getElementById('setting-tokens').value = settings.maxTokens;
                    document.getElementById('val-tokens').innerText = settings.maxTokens;
                    
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },

            reset: () => {
                if(confirm("RESET CONFIG: Restore default system parameters?")) {
                    document.getElementById('setting-api-key').value = "";
                    document.getElementById('setting-system-prompt').value = SettingsUI.defaults.systemPrompt;
                    document.getElementById('setting-temp').value = SettingsUI.defaults.temperature;
                    document.getElementById('val-temp').innerText = SettingsUI.defaults.temperature;
                    document.getElementById('setting-tokens').value = SettingsUI.defaults.maxTokens;
                    document.getElementById('val-tokens').innerText = SettingsUI.defaults.maxTokens;
                    SettingsUI.save();
                }
            },

            save: () => {
                const newSettings = {
                    apiKey: document.getElementById('setting-api-key').value.trim(),
                    systemPrompt: document.getElementById('setting-system-prompt').value.trim(),
                    temperature: parseFloat(document.getElementById('setting-temp').value),
                    maxTokens: parseInt(document.getElementById('setting-tokens').value)
                };
                
                localStorage.setItem('flamefox_settings', JSON.stringify(newSettings));
                
                const modal = document.getElementById('settings-modal');
                modal.classList.add('hidden');
                
                // Show brief visual confirmation
                const statusText = document.getElementById('status-text');
                const originalText = statusText.innerText;
                statusText.innerText = "CONFIG SAVED";
                statusText.classList.add('text-accent');
                setTimeout(() => {
                    statusText.innerText = originalText;
                    statusText.classList.remove('text-accent');
                }, 2000);
            }
        };

        // ---------------------------------------------------------
        // Wrapped UI (NEW: December Feature)
        // ---------------------------------------------------------
        const WrappedUI = {
            // Secret Key Combo: Ctrl + Alt + W
            init: () => {
                const now = new Date();
                const currentYear = now.getFullYear();
                const isDecember = now.getMonth() === 11; 

                const btnText = document.getElementById('wrapped-btn-text');
                const titleYear = document.getElementById('wrapped-title-year');
                
                if(btnText) btnText.innerText = `${currentYear} WRAPPED`;
                if(titleYear) titleYear.innerText = currentYear;

                if (isDecember) {
                    document.getElementById('wrapped-sidebar-btn').classList.remove('hidden');
                }

                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'w' || e.key === 'W')) {
                        e.preventDefault();
                        WrappedUI.open();
                    }
                });
            },

            calculateStats: () => {
                const sessions = SessionManager.getSessions();
                let totalMsgs = 0;
                let totalSessions = sessions.length;
                let totalWords = 0;
                
                sessions.forEach(session => {
                    const userMsgs = session.messages.filter(m => m.role === 'user');
                    totalMsgs += userMsgs.length;
                    userMsgs.forEach(m => {
                        totalWords += m.text.split(' ').length;
                    });
                });

                let archetype = "THE OBSERVER";
                let desc = "Your interaction patterns suggest a careful, analytical approach.";

                if (totalMsgs > 50) {
                     archetype = "THE POWER USER";
                     desc = "You have integrated the neural link into your daily workflow.";
                }
                if (totalMsgs === 0) {
                    archetype = "THE GHOST";
                    desc = "You are here, but you leave no trace. Start chatting to build your profile.";
                }

                return { totalMsgs, totalSessions, totalWords, topModel: 'GROQ', archetype, desc };
            },

            open: () => {
                const stats = WrappedUI.calculateStats();
                document.getElementById('wrap-total-msgs').innerText = stats.totalMsgs;
                document.getElementById('wrap-sessions').innerText = stats.totalSessions;
                document.getElementById('wrap-words').innerText = Math.floor(stats.totalWords * 1.3);
                document.getElementById('wrap-fav-model').innerText = stats.topModel;
                document.getElementById('wrap-archetype').innerText = stats.archetype;
                document.getElementById('wrap-archetype-desc').innerText = stats.desc;
                document.getElementById('wrapped-overlay').classList.remove('hidden');
            },

            close: () => {
                document.getElementById('wrapped-overlay').classList.add('hidden');
            }
        };

        // ---------------------------------------------------------
        // Session Manager
        // ---------------------------------------------------------
        const SessionManager = {
            STORAGE_KEY: 'flamefox_sessions_v2', // version bump
            CURRENT_ID_KEY: 'flamefox_current_id_v2',
            
            getSessions: () => {
                const stored = localStorage.getItem(SessionManager.STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            },

            getCurrentSessionId: () => {
                return localStorage.getItem(SessionManager.CURRENT_ID_KEY);
            },

            setCurrentSessionId: (id) => {
                localStorage.setItem(SessionManager.CURRENT_ID_KEY, id);
            },

            saveSession: (session) => {
                const sessions = SessionManager.getSessions();
                const existingIndex = sessions.findIndex(s => s.id === session.id);
                if (existingIndex >= 0) {
                    sessions[existingIndex] = session;
                } else {
                    sessions.unshift(session); // Add to top
                }
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                SessionManager.renderSessionList();
            },

            createNewSession: () => {
                const newId = 'sys_' + Date.now().toString(36);
                SessionManager.setCurrentSessionId(newId);
                ChatUI.resetUI();
                ChatUI.switchModel('compound-mini');
                SessionManager.renderSessionList(); 
            },

            deleteSession: (id) => {
                if(!confirm("CONFIRM: Delete this entire session log?")) return;
                
                let sessions = SessionManager.getSessions();
                sessions = sessions.filter(s => s.id !== id);
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                
                if (SessionManager.getCurrentSessionId() === id) {
                    SessionManager.createNewSession();
                } else {
                    SessionManager.renderSessionList();
                }
            },

            loadSession: (id) => {
                const sessions = SessionManager.getSessions();
                const session = sessions.find(s => s.id === id);
                if (session) {
                    SessionManager.setCurrentSessionId(id);
                    ChatUI.renderChatHistory(session.messages);
                    SessionManager.renderSessionList();
                }
            },

            appendMessageToCurrent: (role, text, existingId = null) => {
                let currentId = SessionManager.getCurrentSessionId();
                const sessions = SessionManager.getSessions();
                let session = sessions.find(s => s.id === currentId);

                if (!session) {
                    if(!currentId) {
                         currentId = 'sys_' + Date.now().toString(36);
                         SessionManager.setCurrentSessionId(currentId);
                    }
                    session = {
                        id: currentId,
                        title: text.length > 25 ? text.substring(0, 25) + '...' : text,
                        timestamp: Date.now(),
                        messages: [],
                        modelId: 'compound-mini'
                    };
                }

                if (existingId) {
                    const idx = session.messages.findIndex(m => m.id === existingId);
                    if (idx !== -1) {
                        session.messages.splice(idx, 1);
                    }
                }

                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                session.messages.push({ id: msgId, role, text, timestamp: Date.now() });
                SessionManager.saveSession(session);
                return msgId;
            },
            
            getHistory: () => {
                const currentId = SessionManager.getCurrentSessionId();
                const sessions = SessionManager.getSessions();
                const session = sessions.find(s => s.id === currentId);

                if (!session) return [];
                
                // Format for API
                return session.messages
                    .filter(m => m.role !== 'system')
                    .map(m => ({
                        role: m.role,
                        content: m.text
                    }));
            },

            clearAllData: () => {
                if(confirm('CONFIRM WIPE: This will delete all local chat history.')) {
                    localStorage.removeItem(SessionManager.STORAGE_KEY);
                    localStorage.removeItem(SessionManager.CURRENT_ID_KEY);
                    localStorage.removeItem('flamefox_settings'); 
                    location.reload();
                }
            },

            renderSessionList: () => {
                const listEl = document.getElementById('session-list');
                const sessions = SessionManager.getSessions();
                const currentId = SessionManager.getCurrentSessionId();

                if (sessions.length === 0) {
                    listEl.innerHTML = '<div class="text-[10px] text-stone-700 font-mono italic pl-2">NO_LOGS_FOUND</div>';
                    return;
                }

                listEl.innerHTML = sessions.map(s => {
                    const isActive = s.id === currentId;
                    const activeClass = isActive ? 'text-white border-l-accent bg-stone-800' : 'text-stone-400 border-l-transparent hover:text-white hover:border-stone-600 hover:bg-stone-800/50';
                    return `
                        <div class="group flex items-center w-full border-l-2 transition-all font-mono ${activeClass} cursor-pointer">
                            <button onclick="SessionManager.loadSession('${s.id}')" class="flex-1 text-left px-3 py-2 text-xs truncate outline-none">
                                <span class="truncate text-[9px] opacity-50 mr-1">[GROQ]</span>
                                <span class="truncate">> ${s.title}</span>
                            </button>
                            <div class="flex items-center gap-2 pr-2">
                                ${isActive ? '<span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>' : ''}
                                <button onclick="event.stopPropagation(); SessionManager.deleteSession('${s.id}')" class="text-stone-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-700 p-1" title="Delete Session">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            }
        };

        // ---------------------------------------------------------
        // Chat UI Controller & API Logic
        // ---------------------------------------------------------
        const ChatUI = {
            currentModelKey: 'compound-mini',
            
            isGenerating: false,
            latencyUpdateInterval: null,
            generationStartTime: null,
            lastTokenTime: null,
            tokenCount: 0,
            
            init: () => {
                const currentId = SessionManager.getCurrentSessionId();
                if (currentId) {
                    SessionManager.loadSession(currentId);
                } else {
                    SessionManager.createNewSession(); 
                }
            },
            
            switchModel: (modelKey) => {
                // Kept for structure, but only one model supported now
                ChatUI.currentModelKey = modelKey;
                document.querySelectorAll('.model-tab').forEach(el => el.classList.remove('active'));
                const tab = document.getElementById(`tab-${modelKey}`);
                if(tab) tab.classList.add('active');
            },

            setInput: (text) => {
                const input = document.getElementById('user-input');
                input.value = text;
                input.focus();
            },

            resetUI: () => {
                document.getElementById('welcome-section').classList.remove('hidden');
                document.getElementById('chat-history').classList.add('hidden');
                document.getElementById('chat-history').innerHTML = '';
            },

            renderChatHistory: (messages) => {
                const welcome = document.getElementById('welcome-section');
                const historyEl = document.getElementById('chat-history');
                
                if (!messages || messages.length === 0) {
                    ChatUI.resetUI();
                    return;
                }

                welcome.classList.add('hidden');
                historyEl.classList.remove('hidden');
                historyEl.innerHTML = '';

                messages.forEach(msg => {
                    ChatUI.appendMessageToDOM(msg.role, msg.text, false, msg.id);
                });
                ChatUI.scrollToBottom();
            },

            appendMessageToDOM: (role, text, isLoading = false, existingId = null) => {
                const history = document.getElementById('chat-history');
                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                
                const div = document.createElement('div');
                div.id = msgId;
                div.className = `flex w-full group relative transition-opacity duration-300 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                let iconLabel = role === 'user' ? 'USR' : 'GROQ';
                const icon = role === 'user' 
                    ? `<div class="w-8 h-8 shrink-0 bg-stone-800 flex items-center justify-center text-xs font-mono text-stone-400 select-none">${iconLabel}</div>`
                    : `<div class="w-8 h-8 shrink-0 bg-accent flex items-center justify-center text-xs font-mono text-bg font-bold select-none">${iconLabel}</div>`;

                const bubbleClass = role === 'user'
                    ? "bg-stone-800 text-stone-200 border border-stone-700 overflow-hidden"
                    : `bg-transparent text-accent border-accent/50 border relative overflow-hidden`;
                
                const safeText = text
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/\n/g, '<br>');
                    
                const content = isLoading 
                    ? `<span class="animate-pulse">${safeText}</span>` 
                    : safeText;
                
                div.innerHTML = `
                    <div class="flex items-start gap-4 max-w-[85%] md:max-w-[75%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} relative">
                        ${icon}
                        <div class="p-4 ${bubbleClass} font-mono text-sm shadow-lg leading-relaxed break-words">
                            <div class="message-content min-h-[1.5em]">${content}</div>
                        </div>
                    </div>
                `;
                
                history.appendChild(div);
                ChatUI.scrollToBottom();
                return msgId;
            },

            updateSystemMessage: (msgId, newText) => {
                const msgEl = document.getElementById(msgId);
                if (msgEl) {
                    const contentEl = msgEl.querySelector('.message-content');
                    const formatted = newText
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/\n/g, '<br>');

                    contentEl.innerHTML = formatted + `<span class="inline-block w-2 h-4 bg-accent ml-1 animate-pulse"></span>`;
                    ChatUI.scrollToBottom();
                    
                    const tokenEstimate = formatted.split(/\s+/).length;
                    ChatUI.tokenCount = tokenEstimate;
                    ChatUI.updateLatencyDisplay();
                }
            },

            updateLatencyDisplay: () => {
                if (!ChatUI.generationStartTime || ChatUI.tokenCount === 0) return;
                const elapsedMs = Date.now() - ChatUI.generationStartTime;
                const latencyPerToken = elapsedMs / Math.max(1, ChatUI.tokenCount);
                const latencyEl = document.getElementById('latency-val');
                if (latencyEl) latencyEl.innerText = Math.round(latencyPerToken);
            },

            startLatencyTracking: () => {
                ChatUI.generationStartTime = Date.now();
                ChatUI.lastTokenTime = Date.now();
                ChatUI.tokenCount = 0;
                if (ChatUI.latencyUpdateInterval) clearInterval(ChatUI.latencyUpdateInterval);
                ChatUI.latencyUpdateInterval = setInterval(() => ChatUI.updateLatencyDisplay(), 100);
            },

            stopLatencyTracking: () => {
                if (ChatUI.latencyUpdateInterval) {
                    clearInterval(ChatUI.latencyUpdateInterval);
                    ChatUI.latencyUpdateInterval = null;
                }
                ChatUI.updateLatencyDisplay();
            },

            scrollToBottom: () => {
                const scrollArea = document.getElementById('chat-scroll-area');
                scrollArea.scrollTop = scrollArea.scrollHeight;
            },

            setGeneratingState: (isGen) => {
                ChatUI.isGenerating = isGen;
                const btn = document.getElementById('send-btn');
                const icon = document.getElementById('send-icon');
                
                if (isGen) {
                    btn.classList.add('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.remove('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'square');
                    icon.classList.add('fill-current');
                } else {
                    btn.classList.remove('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.add('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'arrow-right');
                    icon.classList.remove('fill-current');
                }
                lucide.createIcons();
            },

            sendMessage: async () => {
                if (ChatUI.isGenerating) {
                    ChatUI.isGenerating = false;
                    return; // The reader loop checks this flag
                }

                const settings = SettingsUI.getSettings();
                
                // CHECK API KEY
                if (!settings.apiKey) {
                    alert("MISSING API KEY: Please enter your Groq API Key in the settings menu.");
                    SettingsUI.toggle();
                    return;
                }

                const inputEl = document.getElementById('user-input');
                const prompt = inputEl.value.trim();
                if (!prompt) return;

                inputEl.value = '';
                document.getElementById('welcome-section').classList.add('hidden');
                document.getElementById('chat-history').classList.remove('hidden');

                const userMsgId = ChatUI.appendMessageToDOM('user', prompt);
                SessionManager.appendMessageToCurrent('user', prompt, userMsgId);
                
                ChatUI.setGeneratingState(true);
                const loadingId = ChatUI.appendMessageToDOM('system', 'INITIALIZING GROQ UPLINK...', true);
                
                ChatUI.startLatencyTracking();
                let accumulatedText = "";
                
                try {
                    // PREPARE MESSAGES
                    const history = SessionManager.getHistory(); // existing history without system
                    const messages = [
                        { role: "system", content: settings.systemPrompt },
                        ...history,
                        { role: "user", content: prompt }
                    ];

                    // FETCH REQUEST (NATIVE)
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${settings.apiKey}`
                        },
                        body: JSON.stringify({
                            messages: messages,
                            model: "groq/compound-mini",
                            temperature: settings.temperature,
                            max_completion_tokens: settings.maxTokens,
                            top_p: 1,
                            stream: true,
                            stop: null,
                            compound_custom: {
                                tools: {
                                    enabled_tools: [
                                        "web_search",
                                        "code_interpreter",
                                        "visit_website",
                                        "browser_automation"
                                    ]
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }

                    // STREAM READER
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        if (!ChatUI.isGenerating) {
                            reader.cancel();
                            break;
                        }

                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(line.substring(6));
                                    const content = json.choices[0]?.delta?.content || "";
                                    accumulatedText += content;
                                    ChatUI.updateSystemMessage(loadingId, accumulatedText);
                                } catch (e) {
                                    console.warn("Error parsing chunk", e);
                                }
                            }
                        }
                    }

                } catch (error) {
                    accumulatedText += `\n\n[SYSTEM_ERROR]: ${error.message}`;
                    ChatUI.updateSystemMessage(loadingId, accumulatedText);
                } finally {
                    ChatUI.stopLatencyTracking();
                    
                    // Final Clean render (removes cursor)
                    const msgEl = document.getElementById(loadingId);
                    if(msgEl) {
                         const contentEl = msgEl.querySelector('.message-content');
                         contentEl.innerHTML = accumulatedText
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/\n/g, '<br>');
                    }

                    SessionManager.appendMessageToCurrent('system', accumulatedText, loadingId);
                    ChatUI.setGeneratingState(false);
                }
            }
        };

        // Initialize on load
        document.addEventListener("DOMContentLoaded", () => {
            // Text Scramble Effect
            const scrambleChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            const spans = document.querySelectorAll('.scramble');
            const scrambleText = (el) => {
                const originalText = el.getAttribute('data-text') || el.innerText;
                if (!el.getAttribute('data-text')) el.setAttribute('data-text', originalText);
                let iteration = 0;
                const interval = setInterval(() => {
                    el.innerText = originalText.split("").map((letter, index) => {
                        if (index < iteration) return originalText[index];
                        return scrambleChars[Math.floor(Math.random() * 26)];
                    }).join("");
                    if (iteration >= originalText.length) clearInterval(interval);
                    iteration += 1 / 3;
                }, 30);
            };
            spans.forEach(span => scrambleText(span));

            // Initialize App
            SessionManager.renderSessionList();
            ChatUI.init();
            WrappedUI.init();
        });
    </script>
</body>
</html>
