<!DOCTYPE html><html lang="en" class="h-full"><head><style data-merge-styles="true"></style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i3-lab | Groq Compound</title>
    <link rel="icon" type="image/x-icon" href="/assets/logo.png">
    
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Marked.js (Markdown Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>

    <!-- Highlight.js (Code Syntax Highlighting) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/ashes.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: '#0c0a09',
                        surface: '#1c1917',
                        surface_hover: '#292524',
                        text: '#e7e5e4',
                        accent: '#ea580c',
                        'accent-dim': '#431407',
                        border: '#44403c',
                        lime: '#84cc16' 
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        :root { --grid-color: rgba(231, 229, 228, 0.05); }
        body {
            background-color: theme('colors.bg');
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: theme('colors.text');
        }
        .raw-border { border: 2px solid theme('colors.border'); }
        .raw-border-focus:focus-within { border-color: theme('colors.accent'); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.stone.800'); }
        ::-webkit-scrollbar-thumb:hover { background: theme('colors.accent'); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            background: theme('colors.accent'); margin-top: -6px; cursor: pointer;
            border: 2px solid theme('colors.bg');
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: theme('colors.stone.800');
        }
        input[type=range]:focus::-webkit-slider-runnable-track { background: theme('colors.stone.700'); }
        .hover-invert { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-invert:hover { background-color: theme('colors.text'); color: theme('colors.bg'); border-color: theme('colors.text'); }
        .hover-invert:hover * { color: theme('colors.bg'); stroke: theme('colors.bg'); }
        .bracket-box { position: relative; }
        .bracket-box::before, .bracket-box::after {
            content: ''; position: absolute; width: 6px; height: 6px;
            border-color: theme('colors.accent'); border-style: solid; transition: all 0.2s ease; opacity: 0;
        }
        .bracket-box::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .bracket-box::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .model-tab {
            @apply px-3 py-1 text-[10px] font-mono font-bold uppercase tracking-widest cursor-pointer border-t border-l border-r border-transparent text-stone-600 transition-all;
        }
        .model-tab.active {
            @apply bg-surface text-accent border-stone-800 border-b-bg translate-y-[1px] z-10;
        }
        .model-tab:hover:not(.active) { @apply text-stone-400 bg-stone-900; }
        .wrapped-gradient-text {
            background: linear-gradient(90deg, #ea580c 0%, #84cc16 50%, #ea580c 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            background-size: 200% auto; animation: wrapped-shine 3s linear infinite;
        }
        @keyframes wrapped-shine { to { background-position: 200% center; } }
        .card-enter { animation: card-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes card-slide-up { to { opacity: 1; transform: translateY(0); } }

        /* MARKDOWN RENDERING STYLES */
        .md-body { font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; line-height: 1.75; color: #d6d3d1; }
        .md-body h1,.md-body h2,.md-body h3,.md-body h4,.md-body h5,.md-body h6 {
            font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em;
            color: #ea580c; margin-top: 1.4em; margin-bottom: 0.5em; line-height: 1.2;
        }
        .md-body h1 { font-size: 1.3rem; border-bottom: 1px solid #44403c; padding-bottom: 0.3em; }
        .md-body h2 { font-size: 1.1rem; }
        .md-body h3 { font-size: 0.95rem; color: #fb923c; }
        .md-body h4,.md-body h5,.md-body h6 { font-size: 0.85rem; color: #fdba74; }
        .md-body p { margin-bottom: 0.85em; color: #d6d3d1; }
        .md-body p:last-child { margin-bottom: 0; }
        .md-body a { color: #fb923c; text-decoration: underline; text-underline-offset: 3px; transition: color 0.15s; }
        .md-body a:hover { color: #ea580c; }
        .md-body ul,.md-body ol { margin: 0.6em 0 0.85em 0; padding-left: 1.5em; }
        .md-body ul { list-style-type: none; }
        .md-body ul li { position: relative; padding-left: 1.2em; margin-bottom: 0.3em; }
        .md-body ul li::before { content: '▸'; position: absolute; left: 0; color: #ea580c; font-size: 0.75em; top: 0.2em; }
        .md-body ol { list-style-type: decimal; }
        .md-body ol li { padding-left: 0.3em; margin-bottom: 0.3em; }
        .md-body ol li::marker { color: #ea580c; font-weight: bold; }
        .md-body ul ul,.md-body ol ol,.md-body ul ol,.md-body ol ul { margin: 0.2em 0; }
        .md-body ul ul li::before { color: #84cc16; content: '◦'; }
        .md-body code:not(pre code) {
            background: #1c1917; border: 1px solid #44403c; color: #84cc16;
            padding: 0.1em 0.45em; border-radius: 0; font-size: 0.82em;
            font-family: 'JetBrains Mono', monospace;
        }
        .md-body pre {
            background: #0c0a09 !important; border: 1px solid #44403c;
            border-left: 3px solid #ea580c; padding: 1em 1.2em;
            overflow-x: auto; margin: 0.85em 0; position: relative;
        }
        .md-body pre code {
            background: transparent !important; border: none !important; padding: 0 !important;
            font-size: 0.82em; color: #a8a29e; font-family: 'JetBrains Mono', monospace;
        }
        .md-body pre .code-lang-label {
            position: absolute; top: 0; right: 0; font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace; text-transform: uppercase;
            letter-spacing: 0.1em; background: #ea580c; color: #0c0a09; padding: 1px 8px; font-weight: 700;
        }
        .md-body pre .copy-btn {
            position: absolute; top: 0; right: 0; font-size: 0.6rem;
            font-family: 'JetBrains Mono', monospace; text-transform: uppercase;
            letter-spacing: 0.1em; background: #1c1917; color: #78716c;
            border: 1px solid #44403c; border-top: none; border-right: none;
            padding: 3px 10px; cursor: pointer; transition: all 0.15s;
        }
        .md-body pre .copy-btn:hover { background: #ea580c; color: #0c0a09; border-color: #ea580c; }
        .md-body blockquote {
            border-left: 3px solid #ea580c; padding: 0.5em 1em; margin: 0.85em 0;
            background: rgba(234, 88, 12, 0.05); color: #a8a29e; font-style: italic;
        }
        .md-body blockquote p { color: #a8a29e; margin-bottom: 0; }
        .md-body hr { border: none; border-top: 1px solid #44403c; margin: 1.2em 0; }
        .md-body table { width: 100%; border-collapse: collapse; margin: 0.85em 0; font-size: 0.8em; overflow-x: auto; display: block; }
        .md-body thead { background: #1c1917; }
        .md-body th { color: #ea580c; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; font-size: 0.75em; padding: 0.5em 0.8em; border: 1px solid #44403c; text-align: left; }
        .md-body td { padding: 0.4em 0.8em; border: 1px solid #292524; color: #d6d3d1; vertical-align: top; }
        .md-body tr:nth-child(even) td { background: rgba(28,25,23,0.5); }
        .md-body tr:hover td { background: rgba(234,88,12,0.04); }
        .md-body strong { color: #f5f5f4; font-weight: 700; }
        .md-body em { color: #a8a29e; font-style: italic; }
        .hljs { background: transparent !important; }

        /* STT mic recording ring animation */
        @keyframes mic-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            70% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        #mic-btn.recording { animation: mic-ring 1.2s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col antialiased selection:bg-accent selection:text-white overflow-hidden">

    <!-- Mobile Header -->
    <header class="md:hidden flex items-center justify-between p-4 border-b border-stone-800 bg-bg/95 backdrop-blur">
        <span class="font-black italic text-lg tracking-tighter text-accent">// i3-lab</span>
        <button onclick="SettingsUI.toggle()" class="text-stone-400 hover:text-white">
            <i data-lucide="settings" class="w-6 h-6"></i>
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="hidden md:flex flex-col border-r border-stone-800 bg-bg/50 backdrop-blur-sm z-20 transition-all duration-300 ease-in-out w-[70px]">
            <div class="p-6 pb-2">
                <button onclick="SidebarUI.toggle()" class="p-2 -ml-2 hover:bg-surface text-stone-400 hover:text-white rounded-none transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="px-4 mb-6 space-y-2 overflow-hidden">
                <button onclick="SessionManager.createNewSession()" class="w-full flex items-center gap-3 px-4 py-3 bg-surface hover:bg-stone-800 border border-stone-700 hover:border-accent transition-all group whitespace-nowrap">
                    <i data-lucide="plus" class="w-4 h-4 text-stone-500 group-hover:text-accent shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest text-stone-300 group-hover:text-white hidden">New_Session</span>
                </button>
            </div>

            <div id="wrapped-sidebar-btn" class="hidden px-4 mb-6 transition-all">
                <button onclick="WrappedUI.open()" class="w-full flex items-center gap-3 px-4 py-2 bg-gradient-to-r from-stone-900 to-transparent border border-accent/30 hover:border-accent hover:shadow-[0_0_15px_-3px_rgba(234,88,12,0.3)] transition-all group whitespace-nowrap relative overflow-hidden">
                    <div class="absolute inset-0 bg-accent/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <i data-lucide="gift" class="w-3 h-3 text-accent group-hover:scale-110 transition-transform relative z-10"></i>
                    <span id="wrapped-btn-text" class="sidebar-text font-mono text-[10px] font-bold uppercase tracking-widest text-accent relative z-10 hidden">2026 WRAPPED</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-4 space-y-1 overflow-x-hidden">
                <div class="sidebar-text font-mono text-[10px] text-stone-600 uppercase tracking-widest mb-3 mt-2 pl-2 border-l border-stone-800 flex justify-between items-center whitespace-nowrap hidden">
                    <span>Recent_Logs</span>
                    <button onclick="SessionManager.clearAllData()" class="text-[9px] hover:text-red-500 cursor-pointer" title="Clear Local Storage">[WIPE_MEM]</button>
                </div>
                <div id="session-list" class="sidebar-text space-y-1 hidden"></div>
            </div>

            <div class="mt-auto bg-bg/80 mb-6 overflow-hidden border-t border-stone-800">
                <button onclick="SettingsUI.toggle()" class="w-full flex items-center gap-3 px-4 py-4 text-stone-400 hover:text-white hover:bg-surface transition-colors whitespace-nowrap">
                    <i data-lucide="settings" class="w-4 h-4 shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest hidden">Settings</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col relative w-full overflow-hidden">

            <div id="chat-scroll-area" class="flex-1 overflow-y-auto w-full flex flex-col items-center pt-8 pb-96">
                
                <div id="welcome-section" class="w-full max-w-4xl px-4 flex flex-col gap-8 md:gap-10 mt-[10vh]">
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 mb-2">
                            <i data-lucide="terminal" class="w-8 h-8 text-accent animate-pulse-slow"></i>
                            <h1 class="text-4xl md:text-5xl font-black tracking-tighter uppercase">
                                <span class="text-transparent stroke-white" style="-webkit-text-stroke: 1px #78716c;">Hello, </span>
                                <span class="scramble text-accent" data-text="USER">USER</span>
                            </h1>
                        </div>
                        <p class="font-mono text-stone-500 text-lg md:text-xl pl-11 border-l-2 border-stone-800">
                            What are we doing today?
                        </p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pl-11">
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Generate a system architecture diagram for a neural network')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="image" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_01</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Generate Arch</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Debug this python error: IndexError: list index out of range')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="code-2" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_02</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Debug Code</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Brainstorm ideas for a new transformer architecture')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_03</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Brainstorm</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Summarize the key differences between RNNs and Transformers')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="graduation-cap" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_04</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Summarize</span>
                        </button>
                    </div>
                </div>

                <div id="chat-history" class="w-full flex flex-col gap-6 px-4 mb-12 hidden"></div>
            </div>

            <!-- Bottom Input Area -->
            <div class="absolute bottom-0 left-0 w-full flex justify-center p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-8">
                <div class="w-full max-w-4xl relative group flex flex-col items-start">
                    
                    <div class="flex gap-1 ml-4 relative top-[1px] z-20">
                        <div id="tab-compound-mini" onclick="ChatUI.switchModel('compound-mini')" class="model-tab active">
                            COMPOUND-MINI
                        </div>
                    </div>

                    <div id="text-input-area" class="w-full bg-surface raw-border raw-border-focus p-4 transition-all duration-300 shadow-[0_0_20px_-10px_rgba(0,0,0,1)] hover:shadow-[0_0_15px_-3px_rgba(234,88,12,0.1)] z-10">
                        <textarea id="user-input" class="w-full bg-transparent border-none focus:ring-0 text-stone-200 placeholder-stone-600 resize-none font-mono text-sm md:text-base h-12 md:h-14 py-2 leading-relaxed" placeholder="Enter command..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); ChatUI.sendMessage(); }"></textarea>
                        
                        <div class="flex justify-between items-center mt-2 border-t border-stone-800 pt-3">
                            <div class="flex gap-2">
                                <button class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600" title="Attach image">
                                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                                </button>
                                <!-- ── MIC BUTTON (STT) ── -->
                                <button
                                    id="mic-btn"
                                    onclick="STT.toggle()"
                                    title="Click to record"
                                    class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-4">
                                <span id="stt-status" class="hidden font-mono text-[10px] text-red-400 animate-pulse">● REC</span>
                                <span class="hidden md:inline font-mono text-[10px] text-stone-600">ENTER TO SEND</span>
                                <button id="send-btn" onclick="ChatUI.sendMessage()" class="text-white p-2 transition-colors w-10 h-10 flex items-center justify-center bg-stone-800 hover:bg-accent">
                                    <i data-lucide="arrow-right" id="send-icon" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-4 left-4 text-[120px] font-black text-stone-900 -z-10 select-none opacity-20 pointer-events-none leading-none tracking-tighter">
                AI/SYS
            </div>
        </main>
    </div>

    <!-- Fixed Footer Status Bar -->
    <div class="fixed bottom-0 left-0 w-full bg-bg border-t border-stone-800 z-50 px-4 py-1 flex justify-between items-center text-[10px] md:text-xs font-mono uppercase tracking-widest text-stone-500">
        <div class="flex gap-4">
            <span class="text-accent flex items-center gap-2">
                <span id="status-indicator" class="w-1.5 h-1.5 bg-accent rounded-full animate-ping"></span>
                <span id="status-text">LIVE</span>
            </span>
            <span class="hidden md:inline">API: <span id="current-api-label" class="text-stone-300">GROQ/COMPOUND-MINI</span></span>
            <span class="hidden md:inline">LATENCY: <span id="latency-val">--</span>ms/token</span>
        </div>
        <div>UI VERSION: 3.5 // GROQ</div>
    </div>

    <!-- WRAPPED OVERLAY -->
    <div id="wrapped-overlay" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-xl hidden flex flex-col items-center justify-center p-4">
        <div class="absolute top-4 right-4 z-50">
            <button onclick="WrappedUI.close()" class="text-stone-500 hover:text-white p-2">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>
        <div class="relative w-full max-w-2xl bg-stone-950 border-2 border-stone-800 p-8 md:p-12 shadow-[0_0_100px_rgba(234,88,12,0.1)] overflow-hidden card-enter">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(rgba(234, 88, 12, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(234, 88, 12, 0.1) 1px, transparent 1px); background-size: 30px 30px;"></div>
            <div class="relative z-10 flex flex-col items-center text-center space-y-8">
                <div class="space-y-2">
                    <div class="font-mono text-xs text-accent tracking-[0.5em] uppercase animate-pulse">Annual System Report</div>
                    <h1 class="text-5xl md:text-7xl font-black italic tracking-tighter wrapped-gradient-text uppercase leading-none">
                        WRAPPED<br><span id="wrapped-title-year" class="text-stone-700" style="-webkit-text-stroke: 1px #44403c;">2026</span>
                    </h1>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full mt-8">
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-accent transition-colors">
                        <i data-lucide="message-square" class="w-6 h-6 text-stone-600 group-hover:text-accent mb-2"></i>
                        <span id="wrap-total-msgs" class="text-3xl font-black text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Prompts</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-lime transition-colors">
                        <i data-lucide="cpu" class="w-6 h-6 text-stone-600 group-hover:text-lime mb-2"></i>
                        <span id="wrap-fav-model" class="text-lg font-bold text-white truncate w-full text-center">GROQ</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Top Arch</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-cyan-500 transition-colors">
                        <i data-lucide="history" class="w-6 h-6 text-stone-600 group-hover:text-cyan-500 mb-2"></i>
                        <span id="wrap-sessions" class="text-3xl font-black text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Sessions</span>
                    </div>
                    <div class="p-4 bg-stone-900/50 border border-stone-800 flex flex-col items-center group hover:border-purple-500 transition-colors">
                        <i data-lucide="type" class="w-6 h-6 text-stone-600 group-hover:text-purple-500 mb-2"></i>
                        <span id="wrap-words" class="text-xl font-bold text-white">0</span>
                        <span class="text-[9px] font-mono text-stone-500 uppercase tracking-wider">Est. Tokens</span>
                    </div>
                </div>
                <div class="w-full border-t border-stone-800 pt-8">
                    <div class="text-[10px] font-mono text-stone-500 mb-2">USER ARCHETYPE DETECTED:</div>
                    <div id="wrap-archetype" class="text-3xl md:text-4xl font-bold text-white uppercase tracking-tight">THE OBSERVER</div>
                    <p id="wrap-archetype-desc" class="text-xs font-mono text-stone-400 mt-2 max-w-md mx-auto">Your interaction patterns suggest a careful, analytical approach to neural interfacing.</p>
                </div>
                <button onclick="WrappedUI.close()" class="px-8 py-3 bg-white text-black font-black font-mono uppercase text-xs hover:bg-accent hover:text-white transition-all hover:shadow-[0_0_20px_rgba(234,88,12,0.5)] mt-4">ACKNOWLEDGE REPORT</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-lg bg-bg border border-stone-700 shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between p-4 border-b border-stone-800 bg-surface">
                <div class="flex items-center gap-2">
                    <i data-lucide="sliders-horizontal" class="w-4 h-4 text-accent"></i>
                    <h2 class="font-mono text-sm font-bold uppercase tracking-widest text-white">System_Configuration</h2>
                </div>
                <button onclick="SettingsUI.toggle()" class="text-stone-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-8">
                <div class="space-y-3 bg-red-900/10 border border-red-900/30 p-4">
                    <div class="flex items-center justify-between">
                         <label class="block font-mono text-xs uppercase text-accent tracking-widest">Groq API Key (Private)</label>
                         <i data-lucide="lock" class="w-3 h-3 text-stone-500"></i>
                    </div>
                    <input type="password" id="setting-api-key" class="w-full bg-stone-950 border border-stone-800 focus:border-accent text-stone-300 font-mono text-xs p-3 outline-none" placeholder="gsk_..." onchange="SettingsUI.save()">
                    <p class="text-[10px] text-stone-500 font-mono">Key is stored in your browser's LocalStorage only. Never sent to any server other than Groq.</p>
                </div>
                <div class="space-y-3">
                    <label class="block font-mono text-xs uppercase text-accent tracking-widest">System Prompt (Persona)</label>
                    <textarea id="setting-system-prompt" class="w-full bg-stone-900 border border-stone-800 focus:border-accent text-stone-300 font-mono text-xs p-3 h-32 resize-none outline-none" placeholder="Enter system instructions here..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">TEMPERATURE</label>
                            <span id="val-temp" class="text-accent">1</span>
                        </div>
                        <input type="range" id="setting-temp" min="0.1" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('val-temp').innerText = this.value">
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">MAX_TOKENS</label>
                            <span id="val-tokens" class="text-accent">1024</span>
                        </div>
                        <input type="range" id="setting-tokens" min="256" max="4096" step="64" value="1024" oninput="document.getElementById('val-tokens').innerText = this.value">
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-stone-800 bg-surface flex justify-between items-center">
                <button onclick="SettingsUI.reset()" class="text-[10px] font-mono text-red-900 hover:text-red-500 uppercase tracking-wider transition-colors">[RESET_DEFAULTS]</button>
                <div class="flex gap-3">
                    <button onclick="SettingsUI.toggle()" class="px-4 py-2 font-mono text-xs text-stone-400 hover:text-white">CANCEL</button>
                    <button onclick="SettingsUI.save()" class="px-6 py-2 bg-accent text-bg font-bold font-mono text-xs hover:bg-orange-500 transition-colors">SAVE CONFIG</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ── Configure marked + highlight.js ────────────────────────────────────
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try { return hljs.highlight(code, { language: lang }).value; } catch (e) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true,
            pedantic: false
        });

        const renderer = new marked.Renderer();
        renderer.code = function(code, lang, escaped) {
            const highlighted = lang && hljs.getLanguage(lang)
                ? hljs.highlight(code, { language: lang }).value
                : hljs.highlightAuto(code).value;
            const langLabel = lang ? `<span class="code-lang-label">${lang.toUpperCase()}</span>` : '';
            const escapedCode = code.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
            return `<pre class="relative group/pre">
                        ${langLabel}
                        <button class="copy-btn" onclick="ChatUI.copyCode(this)" data-code="${escapedCode}">COPY</button>
                        <code class="hljs">${highlighted}</code>
                    </pre>`;
        };
        marked.use({ renderer });

        // ── Sidebar Manager ────────────────────────────────────────────────────
        const SidebarUI = {
            isCollapsed: false,
            toggle: () => {
                const sidebar = document.getElementById('main-sidebar');
                const textElements = document.querySelectorAll('.sidebar-text');
                SidebarUI.isCollapsed = !SidebarUI.isCollapsed;
                if (SidebarUI.isCollapsed) {
                    sidebar.classList.remove('w-[280px]'); sidebar.classList.add('w-[70px]');
                    textElements.forEach(el => el.classList.add('hidden'));
                } else {
                    sidebar.classList.add('w-[280px]'); sidebar.classList.remove('w-[70px]');
                    textElements.forEach(el => el.classList.remove('hidden'));
                }
            }
        };

        // ── Settings Manager ───────────────────────────────────────────────────
        const SettingsUI = {
            defaults: {
                apiKey: "",
                systemPrompt: "You are a helpful, cybernetically enhanced AI assistant.",
                temperature: 1.0,
                maxTokens: 1024
            },
            getSettings: () => {
                const stored = localStorage.getItem('flamefox_settings');
                return stored ? JSON.parse(stored) : SettingsUI.defaults;
            },
            toggle: () => {
                const modal = document.getElementById('settings-modal');
                const isHidden = modal.classList.contains('hidden');
                if (isHidden) {
                    const settings = SettingsUI.getSettings();
                    document.getElementById('setting-api-key').value = settings.apiKey || "";
                    document.getElementById('setting-system-prompt').value = settings.systemPrompt || "";
                    document.getElementById('setting-temp').value = settings.temperature;
                    document.getElementById('val-temp').innerText = settings.temperature;
                    document.getElementById('setting-tokens').value = settings.maxTokens;
                    document.getElementById('val-tokens').innerText = settings.maxTokens;
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },
            reset: () => {
                if(confirm("RESET CONFIG: Restore default system parameters?")) {
                    document.getElementById('setting-api-key').value = "";
                    document.getElementById('setting-system-prompt').value = SettingsUI.defaults.systemPrompt;
                    document.getElementById('setting-temp').value = SettingsUI.defaults.temperature;
                    document.getElementById('val-temp').innerText = SettingsUI.defaults.temperature;
                    document.getElementById('setting-tokens').value = SettingsUI.defaults.maxTokens;
                    document.getElementById('val-tokens').innerText = SettingsUI.defaults.maxTokens;
                    SettingsUI.save();
                }
            },
            save: () => {
                const newSettings = {
                    apiKey: document.getElementById('setting-api-key').value.trim(),
                    systemPrompt: document.getElementById('setting-system-prompt').value.trim(),
                    temperature: parseFloat(document.getElementById('setting-temp').value),
                    maxTokens: parseInt(document.getElementById('setting-tokens').value)
                };
                localStorage.setItem('flamefox_settings', JSON.stringify(newSettings));
                document.getElementById('settings-modal').classList.add('hidden');
                const statusText = document.getElementById('status-text');
                const orig = statusText.innerText;
                statusText.innerText = "CONFIG SAVED";
                setTimeout(() => { statusText.innerText = orig; }, 2000);
            }
        };

        // ── Wrapped UI ─────────────────────────────────────────────────────────
        const WrappedUI = {
            init: () => {
                const now = new Date();
                const year = now.getFullYear();
                const isDecember = now.getMonth() === 11;
                const btnText = document.getElementById('wrapped-btn-text');
                const titleYear = document.getElementById('wrapped-title-year');
                if(btnText) btnText.innerText = `${year} WRAPPED`;
                if(titleYear) titleYear.innerText = year;
                if (isDecember) document.getElementById('wrapped-sidebar-btn').classList.remove('hidden');
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'w' || e.key === 'W')) {
                        e.preventDefault(); WrappedUI.open();
                    }
                });
            },
            calculateStats: () => {
                const sessions = SessionManager.getSessions();
                let totalMsgs = 0, totalSessions = sessions.length, totalWords = 0;
                sessions.forEach(s => {
                    const userMsgs = s.messages.filter(m => m.role === 'user');
                    totalMsgs += userMsgs.length;
                    userMsgs.forEach(m => { totalWords += m.text.split(' ').length; });
                });
                let archetype = "THE OBSERVER", desc = "Your interaction patterns suggest a careful, analytical approach.";
                if (totalMsgs > 50) { archetype = "THE POWER USER"; desc = "You have integrated the neural link into your daily workflow."; }
                if (totalMsgs === 0) { archetype = "THE GHOST"; desc = "You are here, but you leave no trace. Start chatting to build your profile."; }
                return { totalMsgs, totalSessions, totalWords, topModel: 'GROQ', archetype, desc };
            },
            open: () => {
                const stats = WrappedUI.calculateStats();
                document.getElementById('wrap-total-msgs').innerText = stats.totalMsgs;
                document.getElementById('wrap-sessions').innerText = stats.totalSessions;
                document.getElementById('wrap-words').innerText = Math.floor(stats.totalWords * 1.3);
                document.getElementById('wrap-fav-model').innerText = stats.topModel;
                document.getElementById('wrap-archetype').innerText = stats.archetype;
                document.getElementById('wrap-archetype-desc').innerText = stats.desc;
                document.getElementById('wrapped-overlay').classList.remove('hidden');
            },
            close: () => { document.getElementById('wrapped-overlay').classList.add('hidden'); }
        };

        // ── Session Manager ────────────────────────────────────────────────────
        const SessionManager = {
            STORAGE_KEY: 'flamefox_sessions_v2',
            CURRENT_ID_KEY: 'flamefox_current_id_v2',
            getSessions: () => { const s = localStorage.getItem(SessionManager.STORAGE_KEY); return s ? JSON.parse(s) : []; },
            getCurrentSessionId: () => localStorage.getItem(SessionManager.CURRENT_ID_KEY),
            setCurrentSessionId: (id) => localStorage.setItem(SessionManager.CURRENT_ID_KEY, id),
            saveSession: (session) => {
                const sessions = SessionManager.getSessions();
                const idx = sessions.findIndex(s => s.id === session.id);
                if (idx >= 0) sessions[idx] = session; else sessions.unshift(session);
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                SessionManager.renderSessionList();
            },
            createNewSession: () => {
                const newId = 'sys_' + Date.now().toString(36);
                SessionManager.setCurrentSessionId(newId);
                ChatUI.resetUI();
                ChatUI.switchModel('compound-mini');
                SessionManager.renderSessionList();
            },
            deleteSession: (id) => {
                if(!confirm("CONFIRM: Delete this entire session log?")) return;
                let sessions = SessionManager.getSessions().filter(s => s.id !== id);
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                if (SessionManager.getCurrentSessionId() === id) SessionManager.createNewSession();
                else SessionManager.renderSessionList();
            },
            loadSession: (id) => {
                const session = SessionManager.getSessions().find(s => s.id === id);
                if (session) { SessionManager.setCurrentSessionId(id); ChatUI.renderChatHistory(session.messages); SessionManager.renderSessionList(); }
            },
            appendMessageToCurrent: (role, text, existingId = null) => {
                let currentId = SessionManager.getCurrentSessionId();
                const sessions = SessionManager.getSessions();
                let session = sessions.find(s => s.id === currentId);
                if (!session) {
                    if(!currentId) { currentId = 'sys_' + Date.now().toString(36); SessionManager.setCurrentSessionId(currentId); }
                    session = { id: currentId, title: text.length > 25 ? text.substring(0, 25) + '...' : text, timestamp: Date.now(), messages: [], modelId: 'compound-mini' };
                }
                if (existingId) {
                    const idx = session.messages.findIndex(m => m.id === existingId);
                    if (idx !== -1) session.messages.splice(idx, 1);
                }
                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                session.messages.push({ id: msgId, role, text, timestamp: Date.now() });
                SessionManager.saveSession(session);
                return msgId;
            },
            getHistory: () => {
                const currentId = SessionManager.getCurrentSessionId();
                const session = SessionManager.getSessions().find(s => s.id === currentId);
                if (!session) return [];
                return session.messages.filter(m => m.role !== 'system').map(m => ({ role: m.role, content: m.text }));
            },
            // ── FIXED: only wipes chat logs, preserves API key & settings ──
            clearAllData: () => {
                if(confirm('CONFIRM WIPE: This will delete all local chat history.\nYour API Key and settings will be preserved.')) {
                    localStorage.removeItem(SessionManager.STORAGE_KEY);
                    localStorage.removeItem(SessionManager.CURRENT_ID_KEY);
                    location.reload();
                }
            },
            renderSessionList: () => {
                const listEl = document.getElementById('session-list');
                const sessions = SessionManager.getSessions();
                const currentId = SessionManager.getCurrentSessionId();
                if (sessions.length === 0) { listEl.innerHTML = '<div class="text-[10px] text-stone-700 font-mono italic pl-2">NO_LOGS_FOUND</div>'; return; }
                listEl.innerHTML = sessions.map(s => {
                    const isActive = s.id === currentId;
                    const cls = isActive ? 'text-white border-l-accent bg-stone-800' : 'text-stone-400 border-l-transparent hover:text-white hover:border-stone-600 hover:bg-stone-800/50';
                    return `<div class="group flex items-center w-full border-l-2 transition-all font-mono ${cls} cursor-pointer">
                        <button onclick="SessionManager.loadSession('${s.id}')" class="flex-1 text-left px-3 py-2 text-xs truncate outline-none">
                            <span class="truncate text-[9px] opacity-50 mr-1">[GROQ]</span>
                            <span class="truncate">> ${s.title}</span>
                        </button>
                        <div class="flex items-center gap-2 pr-2">
                            ${isActive ? '<span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>' : ''}
                            <button onclick="event.stopPropagation(); SessionManager.deleteSession('${s.id}')" class="text-stone-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-700 p-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            }
        };

        // ── STT (Speech-to-Text via Groq Whisper) ─────────────────────────────
        const STT = {
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false,
            stream: null,

            toggle: async () => {
                if (STT.isRecording) {
                    STT.stop();
                } else {
                    await STT.start();
                }
            },

            start: async () => {
                const settings = SettingsUI.getSettings();
                if (!settings.apiKey) {
                    alert("MISSING API KEY: Please enter your Groq API Key in settings.");
                    SettingsUI.toggle();
                    return;
                }

                try {
                    STT.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    STT.audioChunks = [];

                    // Pick best supported mime type for Groq Whisper
                    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                        ? 'audio/webm;codecs=opus'
                        : MediaRecorder.isTypeSupported('audio/webm')
                            ? 'audio/webm'
                            : MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')
                                ? 'audio/ogg;codecs=opus'
                                : '';

                    STT.mediaRecorder = new MediaRecorder(STT.stream, mimeType ? { mimeType } : {});

                    STT.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) STT.audioChunks.push(e.data);
                    };

                    STT.mediaRecorder.onstop = async () => {
                        STT.setMicState(false);
                        const mType = STT.mediaRecorder.mimeType || 'audio/webm';
                        const blob = new Blob(STT.audioChunks, { type: mType });
                        await STT.transcribe(blob, mType, settings.apiKey);
                    };

                    STT.mediaRecorder.start(250); // collect in 250ms chunks
                    STT.isRecording = true;
                    STT.setMicState(true);

                } catch (err) {
                    console.error('STT start error:', err);
                    if (err.name === 'NotAllowedError') {
                        alert('MICROPHONE ACCESS DENIED: Please allow microphone access in your browser settings.');
                    } else {
                        alert('MICROPHONE ERROR: ' + err.message);
                    }
                }
            },

            stop: () => {
                if (STT.mediaRecorder && STT.mediaRecorder.state !== 'inactive') {
                    STT.mediaRecorder.stop();
                }
                if (STT.stream) {
                    STT.stream.getTracks().forEach(t => t.stop());
                    STT.stream = null;
                }
                STT.isRecording = false;
            },

            transcribe: async (blob, mimeType, apiKey) => {
                const micBtn = document.getElementById('mic-btn');
                const statusText = document.getElementById('status-text');
                const sttStatus = document.getElementById('stt-status');

                if (micBtn) { micBtn.classList.add('animate-pulse'); micBtn.title = 'Transcribing...'; }
                if (statusText) statusText.innerText = 'STT···';
                if (sttStatus) sttStatus.textContent = '◌ STT';

                try {
                    // Map mime to a file extension Groq Whisper accepts
                    const ext = mimeType.includes('ogg') ? 'ogg'
                              : mimeType.includes('mp4') ? 'mp4'
                              : mimeType.includes('mpeg') ? 'mp3'
                              : 'webm';

                    const formData = new FormData();
                    formData.append('file', blob, `audio.${ext}`);
                    formData.append('model', 'whisper-large-v3-turbo');
                    formData.append('temperature', '0');
                    formData.append('response_format', 'verbose_json');

                    const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey}` },
                        body: formData
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error?.message || `HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    const text = (data.text || '').trim();

                    if (text) {
                        const inputEl = document.getElementById('user-input');
                        const cur = inputEl.value.trim();
                        inputEl.value = cur ? cur + ' ' + text : text;
                        inputEl.focus();
                        inputEl.selectionStart = inputEl.selectionEnd = inputEl.value.length;
                    }

                } catch (err) {
                    console.error('STT transcribe error:', err);
                    alert('TRANSCRIPTION ERROR: ' + err.message);
                } finally {
                    if (micBtn) { micBtn.classList.remove('animate-pulse'); micBtn.title = 'Click to record'; }
                    if (statusText) statusText.innerText = 'LIVE';
                    if (sttStatus) { sttStatus.textContent = '● REC'; sttStatus.classList.add('hidden'); }
                }
            },

            setMicState: (recording) => {
                const micBtn = document.getElementById('mic-btn');
                const statusText = document.getElementById('status-text');
                const sttStatus = document.getElementById('stt-status');
                if (!micBtn) return;

                if (recording) {
                    micBtn.classList.add('recording', 'bg-red-900', 'text-red-400');
                    micBtn.classList.remove('text-stone-500', 'hover:text-white');
                    micBtn.title = 'Click to stop recording';
                    if (statusText) statusText.innerText = 'REC ●';
                    if (sttStatus) sttStatus.classList.remove('hidden');
                } else {
                    micBtn.classList.remove('recording', 'bg-red-900', 'text-red-400');
                    micBtn.classList.add('text-stone-500', 'hover:text-white');
                    micBtn.title = 'Click to record';
                    if (statusText) statusText.innerText = 'LIVE';
                    if (sttStatus) sttStatus.classList.add('hidden');
                }
            }
        };

        // ── Chat UI Controller ─────────────────────────────────────────────────
        const ChatUI = {
            currentModelKey: 'compound-mini',
            isGenerating: false,
            latencyUpdateInterval: null,
            generationStartTime: null,
            tokenCount: 0,

            renderMarkdown: (rawText) => marked.parse(rawText || ''),

            copyCode: (btn) => {
                const code = btn.getAttribute('data-code')
                    .replace(/&#39;/g, "'")
                    .replace(/&quot;/g, '"');
                navigator.clipboard.writeText(code).then(() => {
                    const orig = btn.innerText;
                    btn.innerText = 'COPIED!';
                    btn.style.background = '#84cc16';
                    btn.style.color = '#0c0a09';
                    setTimeout(() => { btn.innerText = orig; btn.style.background = ''; btn.style.color = ''; }, 1500);
                });
            },

            init: () => {
                const currentId = SessionManager.getCurrentSessionId();
                if (currentId) SessionManager.loadSession(currentId);
                else SessionManager.createNewSession();
            },

            switchModel: (modelKey) => {
                ChatUI.currentModelKey = modelKey;
                document.querySelectorAll('.model-tab').forEach(el => el.classList.remove('active'));
                const tab = document.getElementById(`tab-${modelKey}`);
                if(tab) tab.classList.add('active');
            },

            setInput: (text) => {
                const input = document.getElementById('user-input');
                input.value = text;
                input.focus();
            },

            resetUI: () => {
                document.getElementById('welcome-section').classList.remove('hidden');
                document.getElementById('chat-history').classList.add('hidden');
                document.getElementById('chat-history').innerHTML = '';
            },

            renderChatHistory: (messages) => {
                const welcome = document.getElementById('welcome-section');
                const historyEl = document.getElementById('chat-history');
                if (!messages || messages.length === 0) { ChatUI.resetUI(); return; }
                welcome.classList.add('hidden');
                historyEl.classList.remove('hidden');
                historyEl.innerHTML = '';
                messages.forEach(msg => ChatUI.appendMessageToDOM(msg.role, msg.text, false, msg.id));
                ChatUI.scrollToBottom();
            },

            appendMessageToDOM: (role, text, isLoading = false, existingId = null) => {
                const history = document.getElementById('chat-history');
                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                const div = document.createElement('div');
                div.id = msgId;
                div.className = `flex w-full group relative transition-opacity duration-300 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                const iconLabel = role === 'user' ? 'USR' : 'GROQ';
                const icon = role === 'user'
                    ? `<div class="w-8 h-8 shrink-0 bg-stone-800 flex items-center justify-center text-xs font-mono text-stone-400 select-none">${iconLabel}</div>`
                    : `<div class="w-8 h-8 shrink-0 bg-accent flex items-center justify-center text-xs font-mono text-bg font-bold select-none">${iconLabel}</div>`;
                const bubbleClass = role === 'user'
                    ? "bg-stone-800 text-stone-200 border border-stone-700 overflow-hidden font-mono text-sm"
                    : "bg-transparent border border-accent/50 relative overflow-hidden";
                let content;
                if (role === 'user') {
                    const safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                    content = isLoading ? `<span class="animate-pulse">${safe}</span>` : safe;
                } else {
                    content = isLoading
                        ? `<span class="font-mono text-sm text-accent animate-pulse">${text}</span>`
                        : `<div class="md-body">${ChatUI.renderMarkdown(text)}</div>`;
                }
                div.innerHTML = `
                    <div class="flex items-start gap-4 max-w-[85%] md:max-w-[75%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} relative">
                        ${icon}
                        <div class="p-4 ${bubbleClass} shadow-lg leading-relaxed break-words">
                            <div class="message-content min-h-[1.5em]">${content}</div>
                        </div>
                    </div>`;
                history.appendChild(div);
                ChatUI.scrollToBottom();
                return msgId;
            },

            updateSystemMessage: (msgId, rawText) => {
                const msgEl = document.getElementById(msgId);
                if (!msgEl) return;
                const contentEl = msgEl.querySelector('.message-content');
                const safe = rawText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                contentEl.innerHTML = `<span class="font-mono text-sm text-stone-300">${safe}</span>`
                    + `<span class="inline-block w-2 h-4 bg-accent ml-1 animate-pulse align-middle"></span>`;
                ChatUI.scrollToBottom();
                ChatUI.tokenCount = rawText.split(/\s+/).length;
                ChatUI.updateLatencyDisplay();
            },

            finalizeSystemMessage: (msgId, rawText) => {
                const msgEl = document.getElementById(msgId);
                if (!msgEl) return;
                const contentEl = msgEl.querySelector('.message-content');
                contentEl.innerHTML = `<div class="md-body">${ChatUI.renderMarkdown(rawText)}</div>`;
            },

            updateLatencyDisplay: () => {
                if (!ChatUI.generationStartTime || ChatUI.tokenCount === 0) return;
                const elapsed = Date.now() - ChatUI.generationStartTime;
                const lat = elapsed / Math.max(1, ChatUI.tokenCount);
                const el = document.getElementById('latency-val');
                if (el) el.innerText = Math.round(lat);
            },

            startLatencyTracking: () => {
                ChatUI.generationStartTime = Date.now();
                ChatUI.tokenCount = 0;
                if (ChatUI.latencyUpdateInterval) clearInterval(ChatUI.latencyUpdateInterval);
                ChatUI.latencyUpdateInterval = setInterval(() => ChatUI.updateLatencyDisplay(), 100);
            },

            stopLatencyTracking: () => {
                if (ChatUI.latencyUpdateInterval) { clearInterval(ChatUI.latencyUpdateInterval); ChatUI.latencyUpdateInterval = null; }
                ChatUI.updateLatencyDisplay();
            },

            scrollToBottom: () => {
                const s = document.getElementById('chat-scroll-area');
                s.scrollTop = s.scrollHeight;
            },

            setGeneratingState: (isGen) => {
                ChatUI.isGenerating = isGen;
                const btn = document.getElementById('send-btn');
                const icon = document.getElementById('send-icon');
                if (isGen) {
                    btn.classList.add('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.remove('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'square');
                    icon.classList.add('fill-current');
                } else {
                    btn.classList.remove('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.add('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'arrow-right');
                    icon.classList.remove('fill-current');
                }
                lucide.createIcons();
            },

            sendMessage: async () => {
                if (ChatUI.isGenerating) { ChatUI.isGenerating = false; return; }

                const settings = SettingsUI.getSettings();
                if (!settings.apiKey) { alert("MISSING API KEY: Please enter your Groq API Key in the settings menu."); SettingsUI.toggle(); return; }

                const inputEl = document.getElementById('user-input');
                const prompt = inputEl.value.trim();
                if (!prompt) return;

                inputEl.value = '';
                document.getElementById('welcome-section').classList.add('hidden');
                document.getElementById('chat-history').classList.remove('hidden');

                const userMsgId = ChatUI.appendMessageToDOM('user', prompt);
                SessionManager.appendMessageToCurrent('user', prompt, userMsgId);

                ChatUI.setGeneratingState(true);
                const loadingId = ChatUI.appendMessageToDOM('system', 'INITIALIZING GROQ UPLINK...', true);

                ChatUI.startLatencyTracking();
                let accumulatedText = "";

                try {
                    const history = SessionManager.getHistory();
                    const messages = [
                        { role: "system", content: settings.systemPrompt },
                        ...history,
                        { role: "user", content: prompt }
                    ];

                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${settings.apiKey}` },
                        body: JSON.stringify({
                            messages,
                            model: "groq/compound-mini",
                            temperature: settings.temperature,
                            max_completion_tokens: settings.maxTokens,
                            top_p: 1,
                            stream: true,
                            stop: null,
                            compound_custom: { tools: { enabled_tools: ["web_search","code_interpreter","visit_website","browser_automation"] } }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.error?.message || `HTTP ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        if (!ChatUI.isGenerating) { reader.cancel(); break; }
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        for (const line of chunk.split('\n')) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const json = JSON.parse(line.substring(6));
                                    accumulatedText += json.choices[0]?.delta?.content || "";
                                    ChatUI.updateSystemMessage(loadingId, accumulatedText);
                                } catch (e) {}
                            }
                        }
                    }
                } catch (error) {
                    accumulatedText += `\n\n**[SYSTEM_ERROR]:** ${error.message}`;
                    ChatUI.updateSystemMessage(loadingId, accumulatedText);
                } finally {
                    ChatUI.stopLatencyTracking();
                    ChatUI.finalizeSystemMessage(loadingId, accumulatedText);
                    SessionManager.appendMessageToCurrent('system', accumulatedText, loadingId);
                    ChatUI.setGeneratingState(false);
                }
            }
        };

        // ── Boot ───────────────────────────────────────────────────────────────
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();

            // Text Scramble
            const scrambleChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            document.querySelectorAll('.scramble').forEach(el => {
                const orig = el.getAttribute('data-text') || el.innerText;
                el.setAttribute('data-text', orig);
                let iteration = 0;
                const iv = setInterval(() => {
                    el.innerText = orig.split("").map((letter, i) => {
                        if (i < iteration) return orig[i];
                        return scrambleChars[Math.floor(Math.random() * 26)];
                    }).join("");
                    if (iteration >= orig.length) clearInterval(iv);
                    iteration += 1 / 3;
                }, 30);
            });

            SessionManager.renderSessionList();
            ChatUI.init();
            WrappedUI.init();
        });
    </script>

</body></html>
