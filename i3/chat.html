<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlameF0X | i3 Interface Chat</title>
    
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: '#0c0a09', // Darker stone
                        surface: '#1c1917',
                        surface_hover: '#292524',
                        text: '#e7e5e4',
                        accent: '#ea580c', // Vibrant orange
                        'accent-dim': '#431407',
                        border: '#44403c',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        :root {
            --grid-color: rgba(231, 229, 228, 0.05);
        }
        
        body {
            background-color: theme('colors.bg');
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: theme('colors.text');
        }

        /* Utilities */
        .raw-border { border: 2px solid theme('colors.border'); }
        .raw-border-focus:focus-within { border-color: theme('colors.accent'); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: theme('colors.bg'); }
        ::-webkit-scrollbar-thumb { background: theme('colors.stone.800'); }
        ::-webkit-scrollbar-thumb:hover { background: theme('colors.accent'); }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: theme('colors.accent');
            margin-top: -6px;
            cursor: pointer;
            border: 2px solid theme('colors.bg');
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: theme('colors.stone.800');
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
            background: theme('colors.stone.700');
        }

        /* Glitch/Hover Effects */
        .hover-invert { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-invert:hover {
            background-color: theme('colors.text');
            color: theme('colors.bg');
            border-color: theme('colors.text');
        }
        .hover-invert:hover * { color: theme('colors.bg'); stroke: theme('colors.bg'); }

        /* Bracket Box (Corner Brackets) */
        .bracket-box { position: relative; }
        .bracket-box::before, .bracket-box::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-color: theme('colors.accent');
            border-style: solid;
            transition: all 0.2s ease;
            opacity: 0;
        }
        .bracket-box::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .bracket-box::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        
        /* Animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Model Selector Tabs */
        .model-tab {
            @apply px-3 py-1 text-[10px] font-mono font-bold uppercase tracking-widest cursor-pointer border-t border-l border-r border-transparent text-stone-600 transition-all;
        }
        .model-tab.active {
            @apply bg-surface text-accent border-stone-800 border-b-bg translate-y-[1px] z-10;
        }
        .model-tab:hover:not(.active) {
            @apply text-stone-400 bg-stone-900;
        }
    </style>
</head>
<body class="h-screen flex flex-col antialiased selection:bg-accent selection:text-white overflow-hidden">

    <!-- Mobile Header -->
    <header class="md:hidden flex items-center justify-between p-4 border-b border-stone-800 bg-bg/95 backdrop-blur">
        <span class="font-black italic text-lg tracking-tighter text-accent">// FLAME.AI</span>
        <button onclick="SettingsUI.toggle()" class="text-stone-400 hover:text-white"><i data-lucide="settings"></i></button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="main-sidebar" class="hidden md:flex flex-col w-[280px] border-r border-stone-800 bg-bg/50 backdrop-blur-sm z-20 transition-all duration-300 ease-in-out">
            <!-- Top / Hamburger -->
            <div class="p-6 pb-2">
                <button onclick="SidebarUI.toggle()" class="p-2 -ml-2 hover:bg-surface text-stone-400 hover:text-white rounded-none transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- New Chat Buttons -->
            <div class="px-4 mb-6 space-y-2 overflow-hidden">
                <!-- Standard Session -->
                <button onclick="SessionManager.createNewSession()" class="w-full flex items-center gap-3 px-4 py-3 bg-surface hover:bg-stone-800 border border-stone-700 hover:border-accent transition-all group whitespace-nowrap">
                    <i data-lucide="plus" class="w-4 h-4 text-stone-500 group-hover:text-accent shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest text-stone-300 group-hover:text-white">New_Session</span>
                </button>
                
                <!-- Temporary i3-1b Session -->
                <button onclick="SessionManager.createTemporaryI3Session()" class="w-full flex items-center gap-3 px-4 py-2 bg-transparent hover:bg-stone-800/50 border border-dashed border-stone-800 hover:border-accent/50 transition-all group whitespace-nowrap">
                    <i data-lucide="flask-conical" class="w-3 h-3 text-stone-600 group-hover:text-orange-400 shrink-0"></i>
                    <span class="sidebar-text font-mono text-[10px] font-bold uppercase tracking-widest text-stone-500 group-hover:text-orange-300">Try i3-1b (Demo)</span>
                </button>
            </div>

            <!-- Recent History -->
            <div class="flex-1 overflow-y-auto px-4 space-y-1 overflow-x-hidden">
                <div class="sidebar-text font-mono text-[10px] text-stone-600 uppercase tracking-widest mb-3 mt-2 pl-2 border-l border-stone-800 flex justify-between items-center whitespace-nowrap">
                    <span>Recent_Logs</span>
                    <button onclick="SessionManager.clearAllData()" class="text-[9px] hover:text-red-500 cursor-pointer" title="Clear Local Storage">[WIPE_MEM]</button>
                </div>
                
                <div id="session-list" class="sidebar-text space-y-1">
                    <!-- Dynamic Sessions will be injected here -->
                </div>
            </div>

            <!-- FOOTER AREA -->
            <div class="mt-auto bg-bg/80 mb-6 overflow-hidden border-t border-stone-800">
                <div id="sidebar-support" class="hidden transition-all duration-500 ease-in-out">
                    <a href="https://ko-fi.com/flamef0x" target="_blank" class="w-full flex items-center gap-3 px-4 py-3 bg-accent/10 border-b border-stone-800 hover:bg-accent hover:text-bg transition-all group whitespace-nowrap">
                        <i data-lucide="coffee" class="w-4 h-4 text-accent group-hover:text-bg shrink-0"></i>
                        <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest text-accent group-hover:text-bg">Support_Dev</span>
                    </a>
                </div>
                <button onclick="SettingsUI.toggle()" class="w-full flex items-center gap-3 px-4 py-4 text-stone-400 hover:text-white hover:bg-surface transition-colors whitespace-nowrap">
                    <i data-lucide="settings" class="w-4 h-4 shrink-0"></i>
                    <span class="sidebar-text font-mono text-xs font-bold uppercase tracking-widest">Settings</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col relative w-full overflow-hidden">

            <!-- CHAT SCROLL AREA -->
            <div id="chat-scroll-area" class="flex-1 overflow-y-auto w-full flex flex-col items-center pt-8 pb-96">
                
                <!-- Welcome/Greeting Section -->
                <div id="welcome-section" class="w-full max-w-4xl px-4 flex flex-col gap-8 md:gap-10 mt-[10vh]">
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 mb-2">
                            <i data-lucide="terminal" class="w-8 h-8 text-accent animate-pulse-slow"></i>
                            <h1 class="text-4xl md:text-5xl font-black tracking-tighter uppercase">
                                <span class="text-transparent stroke-white" style="-webkit-text-stroke: 1px #78716c;">Hello, </span>
                                <span class="scramble text-accent" data-text="USER">GI8rcvI9d</span>
                            </h1>
                        </div>
                        <p class="font-mono text-stone-500 text-lg md:text-xl pl-11 border-l-2 border-stone-800">
                            Select a neural architecture to begin operations.
                        </p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pl-11">
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Generate a system architecture diagram for a neural network')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="image" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_01</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Generate Arch</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Debug this python error: IndexError: list index out of range')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="code-2" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_02</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Debug Code</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Brainstorm ideas for a new transformer architecture')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_03</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Brainstorm</span>
                        </button>
                        <button class="bracket-box text-left p-4 border border-stone-800 bg-surface/30 hover:bg-surface group transition-all" onclick="ChatUI.setInput('Summarize the key differences between RNNs and Transformers')">
                            <div class="flex items-start justify-between mb-2">
                                <i data-lucide="graduation-cap" class="w-5 h-5 text-stone-500 group-hover:text-accent transition-colors"></i>
                                <span class="font-mono text-[10px] text-stone-600 opacity-0 group-hover:opacity-100">CMD_04</span>
                            </div>
                            <span class="font-mono text-xs font-bold text-stone-300 group-hover:text-white block">Summarize</span>
                        </button>
                    </div>

                    <!-- WELCOME SUPPORT SECTION -->
                    <div id="welcome-support" class="pl-11 mt-2">
                        <div class="raw-border border-accent p-6 text-center bg-accent relative overflow-hidden group hover:scale-[1.01] transition-transform duration-300">
                            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(black 1px, transparent 1px); background-size: 20px 20px;"></div>
                            <div class="relative z-10 text-bg flex flex-col md:flex-row items-center justify-between gap-6 text-left">
                                <div>
                                    <h2 class="text-2xl font-black uppercase tracking-tighter mb-1">Fuel the Research</h2>
                                    <p class="font-mono font-bold text-xs opacity-80 max-w-md">
                                        Training SOTA models requires GPU hours. Help keep the servers online.
                                    </p>
                                </div>
                                <div class="shrink-0">
                                    <a href="https://ko-fi.com/flamef0x" target="_blank" class="inline-flex items-center gap-2 px-6 py-3 bg-bg text-accent font-black font-mono uppercase text-sm hover:bg-white hover:text-black transition-all hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5">
                                        <span>Support via Ko-Fi</span>
                                        <i data-lucide="coffee" class="w-4 h-4"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Chat Container -->
                <div id="chat-history" class="w-full max-w-3xl flex flex-col gap-6 px-4 hidden mb-12">
                    <!-- Dynamic messages will be inserted here -->
                </div>

            </div>

            <!-- Bottom Input Area -->
            <div class="absolute bottom-0 left-0 w-full flex justify-center p-4 bg-gradient-to-t from-bg via-bg to-transparent pb-8">
                <div class="w-full max-w-4xl relative group flex flex-col items-start">
                    
                    <!-- MODEL SELECTOR TABS -->
                    <div class="flex gap-1 ml-4 relative top-[1px] z-20">
                        <div id="tab-i3-200m" onclick="ChatUI.switchModel('i3-200m')" class="model-tab active">
                            i3-200m
                        </div>
                        <!-- Removed i3-1b Tab -->
                    </div>

                    <!-- Text Area Container -->
                    <div class="w-full bg-surface raw-border raw-border-focus p-4 transition-all duration-300 shadow-[0_0_20px_-10px_rgba(0,0,0,1)] hover:shadow-[0_0_15px_-3px_rgba(234,88,12,0.1)] z-10">
                        <textarea 
                            id="user-input"
                            class="w-full bg-transparent border-none focus:ring-0 text-stone-200 placeholder-stone-600 resize-none font-mono text-sm md:text-base h-12 md:h-14 py-2 leading-relaxed" 
                            placeholder="Enter command..."
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); ChatUI.sendMessage(); }"
                        ></textarea>
                        
                        <div class="flex justify-between items-center mt-2 border-t border-stone-800 pt-3">
                            <div class="flex gap-2">
                                <button class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600">
                                    <i data-lucide="image-plus" class="w-5 h-5"></i>
                                </button>
                                <button class="p-2 hover:bg-stone-800 text-stone-500 hover:text-white transition-colors rounded-none border border-transparent hover:border-stone-600">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="hidden md:inline font-mono text-[10px] text-stone-600">ENTER TO SEND</span>
                                <button id="send-btn" onclick="ChatUI.sendMessage()" class="bg-stone-800 hover:bg-accent text-white p-2 transition-colors w-10 h-10 flex items-center justify-center">
                                    <i id="send-icon" data-lucide="arrow-right" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Background Decorative Text -->
             <div class="absolute bottom-4 left-4 text-[120px] font-black text-stone-900 -z-10 select-none opacity-20 pointer-events-none leading-none tracking-tighter">
                AI/SYS
            </div>

        </main>
    </div>

    <!-- Fixed Footer Status Bar -->
    <div class="fixed bottom-0 left-0 w-full bg-bg border-t border-stone-800 z-50 px-4 py-1 flex justify-between items-center text-[10px] md:text-xs font-mono uppercase tracking-widest text-stone-500">
        <div class="flex gap-4">
            <span class="text-accent flex items-center gap-2">
                <span id="status-indicator" class="w-1.5 h-1.5 bg-accent rounded-full animate-ping"></span>
                <span id="status-text">LIVE</span>
            </span>
            <span class="hidden md:inline">API: <span id="current-api-label" class="text-stone-300">FLAMEFOX-i3-200m</span></span>
            <span class="hidden md:inline">LATENCY: <span id="latency-val">--</span>ms</span>
        </div>
        <div>
             UI VERSION: 2.2 // WORD-WRAP-FIX
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-bg border border-stone-700 shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col max-h-[90vh]">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-stone-800 bg-surface">
                <div class="flex items-center gap-2">
                    <i data-lucide="sliders-horizontal" class="w-4 h-4 text-accent"></i>
                    <h2 class="font-mono text-sm font-bold uppercase tracking-widest text-white">System_Configuration</h2>
                </div>
                <button onclick="SettingsUI.toggle()" class="text-stone-500 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto space-y-8">
                
                <!-- System Prompt Section -->
                <div class="space-y-3">
                    <label class="block font-mono text-xs uppercase text-accent tracking-widest">System Prompt (Persona)</label>
                    <textarea id="setting-system-prompt" class="w-full bg-stone-900 border border-stone-800 focus:border-accent text-stone-300 font-mono text-xs p-3 h-32 resize-none outline-none" placeholder="Enter system instructions here..."></textarea>
                    <p class="text-[10px] text-stone-600 font-mono">Applied where supported (Mainly i3-200m).</p>
                </div>

                <!-- Parameters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">TEMPERATURE</label>
                            <span id="val-temp" class="text-accent">0.8</span>
                        </div>
                        <input type="range" id="setting-temp" min="0.1" max="1.5" step="0.1" value="0.8" oninput="document.getElementById('val-temp').innerText = this.value">
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between text-xs font-mono">
                            <label class="text-stone-400">MAX_TOKENS</label>
                            <span id="val-tokens" class="text-accent">150</span>
                        </div>
                        <input type="range" id="setting-tokens" min="50" max="1024" step="10" value="150" oninput="document.getElementById('val-tokens').innerText = this.value">
                    </div>
                </div>

                <!-- Privacy Policy -->
                <div class="border border-stone-800 bg-stone-900/50 p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="shield" class="w-3 h-3 text-stone-500"></i>
                        <span class="font-mono text-[10px] uppercase text-stone-500 font-bold">Privacy Protocol</span>
                    </div>
                    <p class="font-mono text-xs text-stone-400 leading-relaxed">
                        // POLICY DECLARATION:<br>
                        I don't store anything and I don't use it for training. All local logs are stored in your browser's LocalStorage and can be wiped via the sidebar.
                    </p>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-stone-800 bg-surface flex justify-between items-center">
                <button onclick="SettingsUI.reset()" class="text-[10px] font-mono text-red-900 hover:text-red-500 uppercase tracking-wider transition-colors">
                    [RESET_DEFAULTS]
                </button>
                <div class="flex gap-3">
                    <button onclick="SettingsUI.toggle()" class="px-4 py-2 font-mono text-xs text-stone-400 hover:text-white">CANCEL</button>
                    <button onclick="SettingsUI.save()" class="px-6 py-2 bg-accent text-bg font-bold font-mono text-xs hover:bg-orange-500 transition-colors">SAVE CONFIG</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // ---------------------------------------------------------
        // Sidebar Manager
        // ---------------------------------------------------------
        const SidebarUI = {
            isCollapsed: false,
            toggle: () => {
                const sidebar = document.getElementById('main-sidebar');
                const textElements = document.querySelectorAll('.sidebar-text');
                
                SidebarUI.isCollapsed = !SidebarUI.isCollapsed;
                
                if (SidebarUI.isCollapsed) {
                    sidebar.classList.remove('w-[280px]');
                    sidebar.classList.add('w-[70px]');
                    // Hide text
                    textElements.forEach(el => el.classList.add('hidden'));
                } else {
                    sidebar.classList.add('w-[280px]');
                    sidebar.classList.remove('w-[70px]');
                    // Show text
                    textElements.forEach(el => el.classList.remove('hidden'));
                }
            }
        };

        // ---------------------------------------------------------
        // Settings Manager
        // ---------------------------------------------------------
        const SettingsUI = {
            defaults: {
                systemPrompt: "",
                temperature: 0.8,
                maxTokens: 150
            },
            
            getSettings: () => {
                const stored = localStorage.getItem('flamefox_settings');
                return stored ? JSON.parse(stored) : SettingsUI.defaults;
            },

            toggle: () => {
                const modal = document.getElementById('settings-modal');
                const isHidden = modal.classList.contains('hidden');
                
                if (isHidden) {
                    // Load current settings into inputs before showing
                    const settings = SettingsUI.getSettings();
                    document.getElementById('setting-system-prompt').value = settings.systemPrompt || "";
                    document.getElementById('setting-temp').value = settings.temperature;
                    document.getElementById('val-temp').innerText = settings.temperature;
                    document.getElementById('setting-tokens').value = settings.maxTokens;
                    document.getElementById('val-tokens').innerText = settings.maxTokens;
                    
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },

            reset: () => {
                if(confirm("RESET CONFIG: Restore default system parameters?")) {
                    document.getElementById('setting-system-prompt').value = SettingsUI.defaults.systemPrompt;
                    document.getElementById('setting-temp').value = SettingsUI.defaults.temperature;
                    document.getElementById('val-temp').innerText = SettingsUI.defaults.temperature;
                    document.getElementById('setting-tokens').value = SettingsUI.defaults.maxTokens;
                    document.getElementById('val-tokens').innerText = SettingsUI.defaults.maxTokens;
                    SettingsUI.save();
                }
            },

            save: () => {
                const newSettings = {
                    systemPrompt: document.getElementById('setting-system-prompt').value.trim(),
                    temperature: parseFloat(document.getElementById('setting-temp').value),
                    maxTokens: parseInt(document.getElementById('setting-tokens').value)
                };
                
                localStorage.setItem('flamefox_settings', JSON.stringify(newSettings));
                
                const modal = document.getElementById('settings-modal');
                modal.classList.add('hidden');
                
                // Show brief visual confirmation
                const statusText = document.getElementById('status-text');
                const originalText = statusText.innerText;
                statusText.innerText = "CONFIG SAVED";
                statusText.classList.add('text-accent');
                setTimeout(() => {
                    statusText.innerText = originalText;
                    statusText.classList.remove('text-accent');
                }, 2000);
            }
        };

        // ---------------------------------------------------------
        // Session Manager (Handles both Persistent and Transient/Demo)
        // ---------------------------------------------------------
        const SessionManager = {
            STORAGE_KEY: 'flamefox_sessions_v1',
            CURRENT_ID_KEY: 'flamefox_current_id',
            
            // Temporary storage for i3-1b demo sessions (RAM only, no localStorage)
            tempSession: null,

            getSessions: () => {
                const stored = localStorage.getItem(SessionManager.STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            },

            getCurrentSessionId: () => {
                return localStorage.getItem(SessionManager.CURRENT_ID_KEY);
            },

            setCurrentSessionId: (id) => {
                localStorage.setItem(SessionManager.CURRENT_ID_KEY, id);
            },

            saveSession: (session) => {
                // GUARD: Never save temp sessions to local storage
                if (session.id === 'temp_demo_session') return;

                const sessions = SessionManager.getSessions();
                const existingIndex = sessions.findIndex(s => s.id === session.id);
                if (existingIndex >= 0) {
                    sessions[existingIndex] = session;
                } else {
                    sessions.unshift(session); // Add to top
                }
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                SessionManager.renderSessionList();
            },

            // Standard "New Session" (Persistent, i3-200m)
            createNewSession: () => {
                SessionManager.tempSession = null; // Clear any temp data
                const newId = 'sys_' + Date.now().toString(36);
                SessionManager.setCurrentSessionId(newId);
                ChatUI.resetUI(); // Clear UI
                ChatUI.switchModel('i3-200m'); // Default model
                SessionManager.renderSessionList(); 
            },

            // Temporary "Demo" Session (Transient, i3-1b)
            createTemporaryI3Session: () => {
                // Define the temp session structure in memory
                SessionManager.tempSession = {
                    id: 'temp_demo_session',
                    title: 'i3-1b [DEMO_MODE]',
                    timestamp: Date.now(),
                    messages: [],
                    modelId: 'i3-1b'
                };
                
                // Set ID to specific string, but don't rely on it for persistence
                SessionManager.setCurrentSessionId('temp_demo_session');
                
                // UI Reset
                ChatUI.resetUI();
                ChatUI.switchModel('i3-1b');
                
                // Render list will unselect other sessions, but won't show this one
                SessionManager.renderSessionList();
            },

            deleteSession: (id) => {
                if(!confirm("CONFIRM: Delete this entire session log?")) return;
                
                let sessions = SessionManager.getSessions();
                sessions = sessions.filter(s => s.id !== id);
                localStorage.setItem(SessionManager.STORAGE_KEY, JSON.stringify(sessions));
                
                // If we deleted the active session, switch to new or another
                if (SessionManager.getCurrentSessionId() === id) {
                    SessionManager.createNewSession();
                } else {
                    SessionManager.renderSessionList();
                }
            },

            loadSession: (id) => {
                // If loading a real session, clear temp
                SessionManager.tempSession = null;

                const sessions = SessionManager.getSessions();
                const session = sessions.find(s => s.id === id);
                if (session) {
                    SessionManager.setCurrentSessionId(id);
                    ChatUI.renderChatHistory(session.messages);
                    
                    if (session.modelId) {
                        ChatUI.switchModel(session.modelId);
                    }
                    
                    SessionManager.renderSessionList();
                }
            },

            // Called when a message is sent or received
            appendMessageToCurrent: (role, text, existingId = null) => {
                let currentId = SessionManager.getCurrentSessionId();
                
                // --- HANDLE TEMPORARY SESSION ---
                if (currentId === 'temp_demo_session') {
                    const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                    if (SessionManager.tempSession) {
                        // Update existing message if editing/streaming
                        if (existingId) {
                             const idx = SessionManager.tempSession.messages.findIndex(m => m.id === existingId);
                             if(idx !== -1) SessionManager.tempSession.messages.splice(idx, 1);
                        }
                        SessionManager.tempSession.messages.push({ id: msgId, role, text, timestamp: Date.now() });
                    }
                    // Do NOT call saveSession
                    return msgId;
                }

                // --- HANDLE PERSISTENT SESSION ---
                const sessions = SessionManager.getSessions();
                let session = sessions.find(s => s.id === currentId);

                if (!session) {
                    if(!currentId) {
                         currentId = 'sys_' + Date.now().toString(36);
                         SessionManager.setCurrentSessionId(currentId);
                    }
                    session = {
                        id: currentId,
                        title: text.length > 25 ? text.substring(0, 25) + '...' : text,
                        timestamp: Date.now(),
                        messages: [],
                        modelId: ChatUI.currentModelKey 
                    };
                }

                if (existingId) {
                    const idx = session.messages.findIndex(m => m.id === existingId);
                    if (idx !== -1) {
                        session.messages.splice(idx, 1);
                    }
                }

                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                session.messages.push({ id: msgId, role, text, timestamp: Date.now() });
                SessionManager.saveSession(session);
                return msgId;
            },
            
            getHistoryForLFM2: () => {
                let currentId = SessionManager.getCurrentSessionId();
                let session;

                // Handle Temp
                if (currentId === 'temp_demo_session') {
                    session = SessionManager.tempSession;
                } else {
                    const sessions = SessionManager.getSessions();
                    session = sessions.find(s => s.id === currentId);
                }

                if (!session) return [];
                
                return session.messages
                    .filter(m => m.role !== 'system')
                    .map(m => ({
                        role: m.role === 'user' ? 'user' : 'assistant',
                        metadata: null,
                        content: m.text,
                        options: null
                    }));
            },

            clearAllData: () => {
                if(confirm('CONFIRM WIPE: This will delete all local chat history.')) {
                    localStorage.removeItem(SessionManager.STORAGE_KEY);
                    localStorage.removeItem(SessionManager.CURRENT_ID_KEY);
                    localStorage.removeItem('flamefox_settings'); 
                    location.reload();
                }
            },

            renderSessionList: () => {
                const listEl = document.getElementById('session-list');
                const sessions = SessionManager.getSessions();
                const currentId = SessionManager.getCurrentSessionId();

                if (sessions.length === 0) {
                    listEl.innerHTML = '<div class="text-[10px] text-stone-700 font-mono italic pl-2">NO_LOGS_FOUND</div>';
                    return;
                }

                listEl.innerHTML = sessions.map(s => {
                    const isActive = s.id === currentId;
                    const activeClass = isActive ? 'text-white border-l-accent bg-stone-800' : 'text-stone-400 border-l-transparent hover:text-white hover:border-stone-600 hover:bg-stone-800/50';
                    const modelTag = s.modelId === 'i3-1b' ? '[1B]' : '';
                    
                    return `
                        <div class="group flex items-center w-full border-l-2 transition-all font-mono ${activeClass} cursor-pointer">
                            <button onclick="SessionManager.loadSession('${s.id}')" class="flex-1 text-left px-3 py-2 text-xs truncate outline-none">
                                <span class="truncate text-[9px] opacity-50 mr-1">${modelTag}</span>
                                <span class="truncate">> ${s.title}</span>
                            </button>
                            <div class="flex items-center gap-2 pr-2">
                                ${isActive ? '<span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>' : ''}
                                <button onclick="event.stopPropagation(); SessionManager.deleteSession('${s.id}')" class="text-stone-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-700 p-1" title="Delete Session">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            }
        };

        // ---------------------------------------------------------
        // Chat UI Controller & API Logic
        // ---------------------------------------------------------
        const ChatUI = {
            currentModelKey: 'i3-200m', // Default
            
            I3_1B_PROMPT: `You are i3, an open-source language model designed by B. Daniel (aka FlameF0X or Daniel Fox on HuggingFace) based on the i3 architecture for natural, human-like conversation.

Core principles:
- Match the user's energy and tone. If they're casual, be casual.
- Be concise by default.
- Use natural language - contractions, colloquialisms, and conversational flow are encouraged.
- Admit when you're uncertain rather than confidently guessing.
- Avoid being preachy, overly formal, or robotic. No unnecessary corporate speak.
- Be helpful and friendly, but not artificially enthusiastic.`,

            MODELS: {
                'i3-200m': {
                    name: 'i3-200m',
                    apiUrl: "https://flamef0x-i3-200m.hf.space/gradio_api/call/predict",
                    type: 'completion'
                },
                'i3-1b': {
                    name: 'i3-1b [LFM2]',
                    apiUrl: "https://flamef0x-lfm2.hf.space/gradio_api/call/chat_with_model",
                    type: 'chat',
                    internalId: "LFM2-1.2B"
                }
            },
            
            abortController: null,
            isGenerating: false,
            
            init: () => {
                const currentId = SessionManager.getCurrentSessionId();
                if (currentId && currentId !== 'temp_demo_session') {
                    SessionManager.loadSession(currentId);
                } else {
                    SessionManager.createNewSession(); // Defaults to 200m
                }
            },
            
            switchModel: (modelKey) => {
                ChatUI.currentModelKey = modelKey;
                
                // Visual Updates for Tabs (Check if tab exists first, since i3-1b tab is removed)
                document.querySelectorAll('.model-tab').forEach(el => el.classList.remove('active'));
                const tab = document.getElementById(`tab-${modelKey}`);
                if(tab) tab.classList.add('active');
                
                // Update Footer
                document.getElementById('current-api-label').innerText = `FLAMEFOX-${modelKey.toUpperCase()}`;
                
                // Update Placeholder
                document.getElementById('user-input').placeholder = `Enter command for ${ChatUI.MODELS[modelKey].name} ...`;
            },

            setInput: (text) => {
                const input = document.getElementById('user-input');
                input.value = text;
                input.focus();
            },

            // State: WELCOME (No Chat)
            resetUI: () => {
                document.getElementById('welcome-section').classList.remove('hidden');
                document.getElementById('chat-history').classList.add('hidden');
                document.getElementById('chat-history').innerHTML = '';
                document.getElementById('sidebar-support').classList.add('hidden');
            },

            renderChatHistory: (messages) => {
                const welcome = document.getElementById('welcome-section');
                const historyEl = document.getElementById('chat-history');
                const sidebarSupport = document.getElementById('sidebar-support');
                
                if (!messages || messages.length === 0) {
                    ChatUI.resetUI();
                    return;
                }

                // State: CHAT ACTIVE
                welcome.classList.add('hidden');
                historyEl.classList.remove('hidden');
                sidebarSupport.classList.remove('hidden');

                historyEl.innerHTML = '';

                messages.forEach(msg => {
                    ChatUI.appendMessageToDOM(msg.role, msg.text, false, msg.id);
                });
                
                ChatUI.scrollToBottom();
            },

            appendMessageToDOM: (role, text, isLoading = false, existingId = null) => {
                const history = document.getElementById('chat-history');
                const msgId = existingId || ('msg-' + Date.now() + Math.random().toString(16).slice(2));
                
                const div = document.createElement('div');
                div.id = msgId;
                div.className = `flex w-full group relative transition-opacity duration-300 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const iconLabel = role === 'user' ? 'USR' : (ChatUI.currentModelKey === 'i3-1b' ? 'LFM' : 'i3');
                
                // Icon
                const icon = role === 'user' 
                    ? `<div class="w-8 h-8 shrink-0 bg-stone-800 flex items-center justify-center text-xs font-mono text-stone-400 select-none">${iconLabel}</div>`
                    : `<div class="w-8 h-8 shrink-0 bg-accent flex items-center justify-center text-xs font-mono text-bg font-bold select-none">${iconLabel}</div>`;

                // Bubble
                const bubbleClass = role === 'user'
                    ? "bg-stone-800 text-stone-200 border border-stone-700 overflow-hidden"
                    : "bg-transparent text-accent border border-accent/50 relative overflow-hidden";
                
                // Content
                const safeText = text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                    .replace(/\n/g, '<br>');

                const content = isLoading 
                    ? `<span class="animate-pulse">${safeText}</span>` 
                    : safeText;
                
                div.innerHTML = `
                    <div class="flex items-start gap-4 max-w-[85%] md:max-w-[75%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} relative">
                        ${icon}
                        <div class="p-4 ${bubbleClass} font-mono text-sm shadow-lg leading-relaxed break-words">
                            <div class="message-content">${content}</div>
                        </div>
                    </div>
                `;
                
                history.appendChild(div);
                ChatUI.scrollToBottom();
                return msgId;
            },

            updateSystemMessage: (msgId, newText) => {
                const msgEl = document.getElementById(msgId);
                if (msgEl) {
                    const contentEl = msgEl.querySelector('.message-content');
                    const formatted = newText
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/\n/g, '<br>');

                    contentEl.innerHTML = formatted;
                    contentEl.innerHTML += `<span class="inline-block w-2 h-4 bg-accent ml-1 animate-pulse"></span>`;
                    ChatUI.scrollToBottom();
                }
            },

            scrollToBottom: () => {
                const scrollArea = document.getElementById('chat-scroll-area');
                scrollArea.scrollTop = scrollArea.scrollHeight;
            },

            stopGeneration: () => {
                if (ChatUI.abortController) {
                    ChatUI.abortController.abort();
                    ChatUI.abortController = null;
                }
            },

            setGeneratingState: (isGen) => {
                ChatUI.isGenerating = isGen;
                const btn = document.getElementById('send-btn');
                const icon = document.getElementById('send-icon');
                
                if (isGen) {
                    // Stop Button Style
                    btn.classList.add('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.remove('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'square');
                    icon.classList.add('fill-current');
                } else {
                    // Send Button Style
                    btn.classList.remove('bg-red-900', 'hover:bg-red-700', 'border-red-500', 'border');
                    btn.classList.add('bg-stone-800', 'hover:bg-accent');
                    icon.setAttribute('data-lucide', 'arrow-right');
                    icon.classList.remove('fill-current');
                }
                lucide.createIcons();
            },

            sendMessage: async () => {
                if (ChatUI.isGenerating) {
                    ChatUI.stopGeneration();
                    return;
                }

                const inputEl = document.getElementById('user-input');
                const prompt = inputEl.value.trim();
                if (!prompt) return;

                // 1. UI Updates
                inputEl.value = '';
                document.getElementById('welcome-section').classList.add('hidden');
                document.getElementById('chat-history').classList.remove('hidden');
                document.getElementById('sidebar-support').classList.remove('hidden');

                // 2. Add User Message
                const userMsgId = ChatUI.appendMessageToDOM('user', prompt);
                SessionManager.appendMessageToCurrent('user', prompt, userMsgId);
                
                // 3. Prepare for Generation
                ChatUI.setGeneratingState(true);
                ChatUI.abortController = new AbortController();
                const signal = ChatUI.abortController.signal;

                const loadingId = ChatUI.appendMessageToDOM('system', 'INITIALIZING_INFERENCE_STREAM...', true);
                
                // Status Update
                const statusText = document.getElementById('status-text');
                const statusInd = document.getElementById('status-indicator');
                if (statusText) statusText.innerText = "PROCESSING...";
                if (statusInd) {
                    statusInd.classList.remove('bg-green-500');
                    statusInd.classList.add('bg-orange-500', 'animate-ping');
                }
                
                const startTime = Date.now();
                let accumulatedText = "";

                // FETCH SETTINGS
                const settings = SettingsUI.getSettings();
                const currentModel = ChatUI.MODELS[ChatUI.currentModelKey];

                try {
                    let requestBody;

                    if (currentModel.type === 'completion') {
                        // --- API LOGIC FOR i3-200m ---
                        let finalPrompt = prompt;
                        if(settings.systemPrompt && settings.systemPrompt.trim() !== "") {
                            finalPrompt = `System: ${settings.systemPrompt}\n\nUser: ${prompt}`;
                        }
                        
                        requestBody = {
                            data: [ 
                                finalPrompt, 
                                settings.maxTokens, 
                                settings.temperature, 
                                40 
                            ]
                        };

                    } else if (currentModel.type === 'chat') {
                        // --- API LOGIC FOR i3-1b (LFM2) ---
                        const fullHistory = SessionManager.getHistoryForLFM2();
                        const historyBase = fullHistory.slice(0, -1); 
                        
                        const historyToSend = [
                            { role: "system", content: ChatUI.I3_1B_PROMPT },
                            ...historyBase
                        ];

                        requestBody = {
                            data: [
                                prompt, 
                                historyToSend, 
                                currentModel.internalId 
                            ]
                        };
                    }

                    // 4. API Call
                    const response = await fetch(currentModel.apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody),
                        signal
                    });

                    if (!response.ok) throw new Error("Connection Refused / API Error");
                    
                    const json = await response.json();
                    const eventId = json.event_id;
                    const streamUrl = `${currentModel.apiUrl}/${eventId}`;
                    
                    const streamResponse = await fetch(streamUrl, { signal });
                    const reader = streamResponse.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.replace('data: ', '').trim();
                                try {
                                    const data = JSON.parse(dataStr);
                                    
                                    if (Array.isArray(data) && data.length > 0) {
                                        if (currentModel.type === 'completion') {
                                             accumulatedText = data[0]; 
                                        } else {
                                            const payload = data[0];
                                            if (typeof payload === 'string') {
                                                accumulatedText = payload;
                                            } else if (Array.isArray(payload) && payload.length > 0) {
                                                const lastItem = payload[payload.length - 1];
                                                if (Array.isArray(lastItem) && lastItem.length > 1) {
                                                    accumulatedText = lastItem[1];
                                                } 
                                                else if (typeof lastItem === 'object' && lastItem !== null && lastItem.content) {
                                                    accumulatedText = lastItem.content;
                                                }
                                            }
                                        }

                                        // --- SAFETY: CLIENT-SIDE STOP TOKENS ---
                                        const stopSequences = ["\nUser:", "\nuser:", "User:", "user:"];
                                        let shouldStop = false;
                                        
                                        for (const stop of stopSequences) {
                                            if (accumulatedText.includes(stop)) {
                                                accumulatedText = accumulatedText.split(stop)[0].trim();
                                                shouldStop = true;
                                                break;
                                            }
                                        }
                                        
                                        if(accumulatedText) {
                                            ChatUI.updateSystemMessage(loadingId, accumulatedText);
                                        }

                                        if (shouldStop) {
                                            reader.cancel(); 
                                            break; 
                                        }
                                    }
                                } catch (e) { /* Ignore control messages */ }
                            }
                        }
                        if (accumulatedText.includes("\nUser:") || accumulatedText.includes("User:")) break;
                    }

                } catch (error) {
                    if (error.name === 'AbortError') {
                        accumulatedText += "\n[SYSTEM_INTERRUPT: GENERATION_HALTED_BY_USER]";
                        ChatUI.updateSystemMessage(loadingId, accumulatedText);
                    } else {
                        console.error(error);
                        ChatUI.updateSystemMessage(loadingId, `ERROR: ${error.message}\nCHECK_CONNECTION_AND_RETRY.`);
                    }
                } finally {
                    // 5. Cleanup & Save
                    const msgEl = document.getElementById(loadingId);
                    if(msgEl) {
                         const contentEl = msgEl.querySelector('.message-content');
                         const safeFinal = accumulatedText
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/\n/g, '<br>');
                         contentEl.innerHTML = safeFinal;
                    }

                    SessionManager.appendMessageToCurrent('system', accumulatedText, loadingId);
                    
                    const duration = Date.now() - startTime;
                    const latencyEl = document.getElementById('latency-val');
                    if (latencyEl) latencyEl.innerText = duration;

                    if(statusText) statusText.innerText = "SYSTEM ONLINE";
                    if(statusInd) {
                        statusInd.classList.remove('bg-orange-500', 'animate-ping');
                        statusInd.classList.add('bg-green-500');
                    }
                    
                    ChatUI.setGeneratingState(false);
                    ChatUI.abortController = null;
                }
            }
        };

        // Boot
        document.addEventListener("DOMContentLoaded", () => {
            // Text Scramble Effect
            const scrambleChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            const spans = document.querySelectorAll('.scramble');
            const scrambleText = (el) => {
                const originalText = el.getAttribute('data-text') || el.innerText;
                if (!el.getAttribute('data-text')) el.setAttribute('data-text', originalText);
                let iteration = 0;
                const interval = setInterval(() => {
                    el.innerText = originalText.split("").map((letter, index) => {
                        if (index < iteration) return originalText[index];
                        return scrambleChars[Math.floor(Math.random() * 26)];
                    }).join("");
                    if (iteration >= originalText.length) clearInterval(interval);
                    iteration += 1 / 3;
                }, 30);
            };
            spans.forEach(span => scrambleText(span));

            // Init Chat
            ChatUI.init();
        });
    </script>
</body>
</html>
