<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book name, something something - Daniel.FlameFox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn-avatars.huggingface.co/v1/production/uploads/6615494716917dfdc645c44e/-qgGeUlEsf5z-jilWawyO.png" type="image/png">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary: #6366f1; /* Indigo 500 */
            --primary-light: #818cf8; /* Indigo 400 */
            --primary-dark: #4f46e5; /* Indigo 600 */
            --dark-bg: #0f172a; /* Slate 900 */
            --card-bg: #1e293b; /* Slate 800 */
            --text: #f8fafc; /* Slate 50 */
            --text-secondary: #cbd5e1; /* Slate 300 */
            --new-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Custom gradient for emphasis */
            --new-glow: 0 0 30px rgba(102, 102, 234, 0.3); /* Subtle glow effect */
            --nsfw-red: #ef4444; /* Red 500 for NSFW tags */
            --nsfw-red-dark: #dc2626; /* Red 600 for darker NSFW elements */
            --tag-bg: #374151; /* Gray 700 for regular tags */
            --tag-hover: #4b5563; /* Gray 600 for tag hover */
        }

        /* Global reset and font settings */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        /* Body styling */
        body {
            min-height: 100vh;
            background-color: var(--dark-bg);
            color: var(--text);
            line-height: 1.6; /* Improved readability */
        }

        /* Main container for content */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header styling */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        /* Logo styling with gradient text */
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Navigation menu styling */
        .nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
        }

        .nav a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        /* Underline effect on hover for navigation links */
        .nav a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .nav a:hover {
            color: var(--primary-light);
        }

        .nav a:hover:after {
            width: 100%;
        }

        /* Section styling for main content areas */
        .section {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin-bottom: 1.5rem;
        }

        /* Controls for sorting/filtering chapters */
        .sort-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Space between elements */
        }

        .sort-select {
            background-color: var(--card-bg);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none; /* Remove default select arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cbd5e1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-6.5%200-12.3%203.2-16.1%208.1-3.9%204.9-4.7%2011.6-2.6%2017.6l139%20168c4.4%205.3%2010.8%208.6%2017.8%208.6s13.4-3.3%2017.8-8.6l139-168c2.1-6%201.3-12.7-2.6-17.6z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0;
            background-size: 0.65em auto, 100%;
        }

        .sort-select:hover {
            border-color: var(--primary-light);
        }

        /* Chapter summary styling */
        .chapter-summary, .character-summary {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            background: #212e43; /* Darker background for individual chapters */
            padding: 20px;
            border-radius: 15px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .chapter-summary:hover, .character-summary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-light); /* Highlight border on hover */
        }

        /* Chapter title styling */
        .chapter-title, .character-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-light);
            cursor: pointer;
            transition: color 0.3s;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .chapter-summary:hover .chapter-title, .character-summary:hover .character-name {
            color: var(--primary); /* Darker primary on hover */
        }

        /* Chapter date/metadata styling */
        .chapter-meta, .character-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-family: 'Roboto Mono', monospace;
        }

        /* Chapter content summary styling */
        .chapter-content-summary, .character-description-summary {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Tags container styling */
        .chapter-tags, .character-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        /* Individual tag styling */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background-color: var(--tag-bg);
            color: var(--text);
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .tag:hover {
            background-color: var(--tag-hover);
            transform: translateY(-1px);
        }

        /* NSFW tag styling */
        .tag.nsfw {
            background-color: var(--nsfw-red);
            color: white;
            border-color: var(--nsfw-red-dark);
            animation: pulse-red 2s infinite;
        }

        .tag.nsfw:hover {
            background-color: var(--nsfw-red-dark);
        }

        /* Pulse animation for NSFW tags */
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 5px rgba(239, 68, 68, 0);
            }
        }

        /* Age verification modal styling */
        .age-verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .age-verification-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--nsfw-red);
        }

        .age-verification-title {
            color: var(--nsfw-red);
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .age-verification-text {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .age-verification-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .age-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .age-btn.confirm {
            background-color: var(--primary);
            color: white;
        }

        .age-btn.confirm:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .age-btn.decline {
            background-color: var(--nsfw-red);
            color: white;
        }

        .age-btn.decline:hover {
            background-color: var(--nsfw-red-dark);
            transform: translateY(-2px);
        }

        .privacy-notice {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            font-style: italic;
        }

        /* Back button styling */
        .back-btn { /* Changed from ID to class for reusability */
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-light);
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: color 0.3s;
            font-size: 1.1rem; /* Slightly larger for better clickability */
            font-weight: 500;
        }

        .back-btn:hover {
            color: var(--primary);
        }

        /* Full chapter content styling */
        .chapter-full-content, .character-full-details {
            line-height: 1.8; /* Increased line-height for readability of long text */
            color: var(--text-secondary);
            margin-top: 1rem;
            font-size: 1.05rem; /* Slightly larger font for main content */
        }

        .chapter-full-content h1,
        .chapter-full-content h2,
        .chapter-full-content h3,
        .chapter-full-content h4,
        .chapter-full-content h5,
        .chapter-full-content h6,
        .character-full-details h1,
        .character-full-details h2,
        .character-full-details h3,
        .character-full-details h4,
        .character-full-details h5,
        .character-full-details h6 {
            color: var(--primary-light);
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
        }

        .chapter-full-content p, .character-full-details p {
            margin-bottom: 1rem;
        }

        .chapter-full-content ul,
        .chapter-full-content ol,
        .character-full-details ul,
        .character-full-details ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .chapter-full-content li, .character-full-details li {
            margin-bottom: 0.5rem;
        }

        /* Section title for "Table of Contents" */
        .section-title {
            font-size: 2rem;
            margin-bottom: 0;
            background: linear-gradient(to right, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Hidden class for age verification */
        .hidden {
            display: none !important;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .sort-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .section-title {
                font-size: 1.75rem;
            }

            .chapter-title, .character-name {
                font-size: 1.3rem;
            }

            .chapter-summary, .character-summary {
                padding: 15px;
            }

            .age-verification-content {
                padding: 1.5rem;
            }

            .age-verification-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>Book name, something something</span>
            </div>
            <nav class="nav">
                <ul>
                    <li><a href="#" id="home-link">Table of Contents</a></li>
                    <li><a href="#" id="wiki-link">Characters Wiki</a></li> <!-- New Wiki Link -->
                </ul>
            </nav>
        </header>

        <div class="sort-controls">
            <h1 class="section-title" id="main-title">Table of Contents</h1>
            <select class="sort-select" id="sort-select">
                <option value="chapter-asc">Chapter Number (Asc)</option>
                <option value="chapter-desc">Chapter Number (Desc)</option>
                <option value="title-asc">Title (A-Z)</option>
                <option value="title-desc">Title (Z-A)</option>
            </select>
        </div>

        <div id="chapters-list" class="section"></div>
        <div id="chapter-content" class="section" style="display: none;"></div>
        <div id="wiki-list" class="section" style="display: none;"></div> <!-- New Wiki List Container -->
        <div id="character-content" class="section" style="display: none;"></div> <!-- New Character Detail Container -->

        <!-- Age Verification Modal -->
        <div id="age-verification-modal" class="age-verification-modal hidden">
            <div class="age-verification-content">
                <div class="age-verification-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Age Verification Required
                </div>
                <div class="age-verification-text">
                    This content contains mature themes and is intended for adults only. 
                    You must be 18 years or older to view this content.
                    <br><br>
                    Are you 18 years of age or older?
                </div>
                <div class="age-verification-buttons">
                    <button class="age-btn confirm" id="age-confirm">Yes, I am 18+</button>
                    <button class="age-btn decline" id="age-decline">No, I am under 18</button>
                </div>
                <div class="privacy-notice">
                    We do not store or track your age information. This verification is only used for content safety purposes.
                </div>
            </div>
        </div>

        <script>
            // Mock book.json content for demonstration purposes.
            // In a real scenario, this would be fetched from a 'book.json' file.
            /*
            [
                {
                    "id": "chap1",
                    "chapterNumber": 1,
                    "title": "The Whispering Woods",
                    "date": "2023-01-15",
                    "summary": "A young adventurer embarks on a perilous journey through the ancient, enchanted Whispering Woods, encountering strange creatures and forgotten lore.",
                    "content": "<p>Deep within the heart of the Eldoria, lay the Whispering Woods, a place of ancient magic and forgotten tales. Elara, a young apprentice cartographer, found herself drawn to its mysteries, armed with only a compass and her grandmother's cryptic notes...</p><p>The trees themselves seemed to hum with a low, resonant energy, and the path ahead was barely visible beneath a carpet of luminous moss. Every rustle of leaves, every distant hoot of an owl, felt like a secret whispered just for her ears.</p>"
                },
                {
                    "id": "chap2",
                    "chapterNumber": 2,
                    "title": "Shadows of the Forgotten City",
                    "date": "2023-02-20",
                    "summary": "Elara discovers the ruins of an ancient city, long lost to time, and uncovers a dark secret that threatens the balance of the realm.",
                    "content": "<p>Beyond the Whispering Woods, hidden by an illusion woven by powerful mages, lay the ruins of Aerthos, the forgotten city. Its stone structures, once grand and imposing, were now crumbling husks, overgrown with vines and shrouded in an eerie silence.</p><p>As Elara delved deeper, she found murals depicting a civilization that worshipped shadows, and a chilling prophecy foretelling a great darkness. The air grew heavy, and a sense of dread settled upon her as she realized the true nature of the city's demise.</p>"
                },
                {
                    "id": "chap3",
                    "chapterNumber": 3,
                    "title": "The Crimson Blade",
                    "date": "2023-03-10",
                    "summary": "A fierce battle ensues as Elara confronts the ancient evil awakened in Aerthos, wielding a legendary artifact to save her world.",
                    "tags": ["Action", "Fantasy", "Violence", "NSFW"],
                    "content": "<p>The air crackled with raw magic as the ancient entity, a being of pure shadow, rose from the depths of Aerthos. Its form was a swirling vortex of darkness, eyes glowing with malevolent intent. Elara, gripping the newly discovered Crimson Blade, felt a surge of ancient power flow through her veins.</p><p>The clash was cataclysmic. Spells of light met waves of shadow, and the ground trembled with each strike of the Crimson Blade. This was not merely a fight for survival, but a battle for the very soul of Eldoria. The details of the struggle were brutal, unforgiving, and left an indelible mark on the landscape and on Elara's spirit.</p>"
                }
            ]
            */

            // Mock wiki.json content for demonstration purposes.
            // In a real scenario, this would be fetched from a 'wiki.json' file.
            /*
            [
              {
                "id": "char1",
                "name": "Anya",
                "age": 19,
                "genderPronouns": "She/Her",
                "sexuality": "Heterosexual",
                "occupation": "Apprentice Mage",
                "description": "A young, aspiring mage with a knack for elemental magic, particularly fire. She is fiercely loyal to her friends and possesses a strong sense of justice. Anya often struggles with controlling her emotions, which can sometimes lead to unpredictable magical outbursts.",
                "backstoryShort": "Raised in a small village, Anya discovered her magical abilities at a young age, leading her to the Arcane Academy. After a tragic incident, she left the Academy to join the Ember Guard, seeking to use her powers for good.",
                "abilities": ["Pyromancy", "Basic Healing Spells", "Enhanced Agility"],
                "affiliations": ["Arcane Academy (former student)", "The Ember Guard"],
                "firstAppearance": "Chapter 1: The First Spark"
              },
              {
                "id": "char2",
                "name": "Kael",
                "age": 35,
                "genderPronouns": "He/Him",
                "sexuality": "Asexual",
                "occupation": "Wanderer, former Soldier",
                "description": "A stoic and experienced warrior, Kael is a master of close combat and an expert tracker. He carries a heavy burden from his past, which often makes him reserved and cautious. Despite his gruff exterior, he has a hidden soft spot for those he protects.",
                "backstoryShort": "Once a decorated soldier, Kael deserted his post after a morally compromising mission. He now roams the lands, seeking to atone for his past and find a new purpose, often helping those in need from the shadows.",
                "abilities": ["Swordsmanship", "Tracking", "Survivalist"],
                "affiliations": ["The Silent Blades (disbanded)", "The Nomad Collective"],
                "firstAppearance": "Chapter 2: Echoes in the Forest"
              },
              {
                "id": "char3",
                "name": "Lyra",
                "age": 24,
                "genderPronouns": "She/Her",
                "sexuality": "Pansexual",
                "occupation": "Rogue, Information Broker",
                "description": "A mischievous and cunning rogue, Lyra excels in stealth and subterfuge. She has a sharp wit and an even sharper dagger. While she often operates alone, her loyalty, once earned, is unwavering. She has a mysterious connection to the underworld of the city.",
                "backstoryShort": "Orphaned at a young age, Lyra grew up on the streets, learning to survive by her wits. She became an adept rogue and carved out a niche as an information broker, navigating the city's criminal underbelly with ease.",
                "abilities": ["Stealth", "Lockpicking", "Dagger Combat", "Shadow Manipulation"],
                "affiliations": ["The Shadow Syndicate (loose ties)"],
                "firstAppearance": "Chapter 3: Whispers in the Alley"
              },
              {
                "id": "char4",
                "name": "Professor Eldrin",
                "age": 68,
                "genderPronouns": "He/Him",
                "sexuality": "N/A",
                "occupation": "Archivist, Scholar",
                "description": "An eccentric but brilliant scholar and archivist, Professor Eldrin possesses vast knowledge of ancient history and forgotten languages. He is often lost in his books but can provide invaluable insights when his attention is captured. He has a peculiar habit of talking to himself.",
                "backstoryShort": "Professor Eldrin has dedicated his life to the pursuit of knowledge, spending decades within the Grand Library of Veridia. His past is shrouded in academic pursuits and quiet research, with little known beyond his scholarly achievements.",
                "abilities": ["Ancient Lore", "Linguistics", "Minor Illusions"],
                "affiliations": ["Grand Library of Veridia"],
                "firstAppearance": "Chapter 4: The Forgotten Scrolls"
              }
            ]
            */

            const chaptersListEl = document.getElementById('chapters-list');
            const chapterContentEl = document.getElementById('chapter-content');
            const wikiListEl = document.getElementById('wiki-list'); // New Wiki List Element
            const characterContentEl = document.getElementById('character-content'); // New Character Detail Element
            const sortSelect = document.getElementById('sort-select');
            const mainTitleEl = document.getElementById('main-title');
            const homeLinkEl = document.getElementById('home-link');
            const wikiLinkEl = document.getElementById('wiki-link'); // New Wiki Link Element
            const ageModal = document.getElementById('age-verification-modal');
            const ageConfirm = document.getElementById('age-confirm');
            const ageDecline = document.getElementById('age-decline');
            
            let chapters = [];
            let characters = []; // To store character data
            let ageVerified = false;
            let pendingNsfwChapter = null;
            let currentView = 'chapters'; // 'chapters', 'wiki', 'chapter-detail', 'character-detail'

            /**
             * Shows the age verification modal
             */
            function showAgeVerification(chapter) {
                pendingNsfwChapter = chapter;
                ageModal.classList.remove('hidden');
            }

            /**
             * Hides the age verification modal
             */
            function hideAgeVerification() {
                ageModal.classList.add('hidden');
                pendingNsfwChapter = null;
            }

            /**
             * Renders a tag element
             */
            function renderTag(tag) {
                const isNsfw = tag.toLowerCase() === 'nsfw';
                const icon = isNsfw ? '<i class="fas fa-exclamation-triangle"></i>' : '';
                const className = isNsfw ? 'tag nsfw' : 'tag';
                
                return `<span class="${className}">${icon}${tag}</span>`;
            }

            /**
             * Sorts the chapters based on the selected option and re-renders the table of contents.
             */
            function sortChapters() {
                switch(sortSelect.value) {
                    case 'chapter-asc':
                        chapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
                        break;
                    case 'chapter-desc':
                        chapters.sort((a, b) => b.chapterNumber - a.chapterNumber);
                        break;
                    case 'title-asc':
                        chapters.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'title-desc':
                        chapters.sort((a, b) => b.title.localeCompare(a.title));
                        break;
                }
                renderTableOfContents();
            }

            /**
             * Renders the list of chapters as a table of contents.
             * Hides other views.
             */
            function renderTableOfContents() {
                chapterContentEl.style.display = 'none';
                wikiListEl.style.display = 'none';
                characterContentEl.style.display = 'none';
                chaptersListEl.style.display = 'block';
                
                mainTitleEl.textContent = 'Table of Contents';
                sortSelect.style.display = 'block';
                currentView = 'chapters';

                chaptersListEl.innerHTML = chapters.map(chapter => {
                    const tagsHtml = chapter.tags && chapter.tags.length > 0 
                        ? `<div class="chapter-tags">${chapter.tags.map(tag => renderTag(tag)).join('')}</div>`
                        : '';
                    
                    return `
                        <div class="chapter-summary" data-id="${chapter.id}">
                            <div class="chapter-title">Chapter ${chapter.chapterNumber}: ${chapter.title}</div>
                            <div class="chapter-meta">Published: ${chapter.date}</div>
                            ${tagsHtml}
                            <div class="chapter-content-summary">${chapter.summary}</div>
                        </div>
                    `;
                }).join('');
            }

            /**
             * Displays the full content of a selected chapter.
             * Hides other views.
             * @param {Object} chapter - The chapter object to display.
             */
            function showChapter(chapter) {
                chaptersListEl.style.display = 'none';
                sortSelect.style.display = 'none';
                wikiListEl.style.display = 'none';
                characterContentEl.style.display = 'none';
                chapterContentEl.style.display = 'block';
                
                mainTitleEl.textContent = chapter.title;
                currentView = 'chapter-detail';

                const tagsHtml = chapter.tags && chapter.tags.length > 0 
                    ? `<div class="chapter-tags">${chapter.tags.map(tag => renderTag(tag)).join('')}</div>`
                    : '';

                chapterContentEl.innerHTML = `
                    <div class="back-btn" data-target="chapters-list">
                        <i class="fas fa-arrow-left"></i>
                        Back to Table of Contents
                    </div>
                    <h2 class="chapter-title" style="font-size: 2rem; margin-bottom: 0.5rem;">${chapter.title}</h2>
                    <div class="chapter-meta">Chapter ${chapter.chapterNumber} | Published: ${chapter.date}</div>
                    ${tagsHtml}
                    <div class="chapter-full-content">${chapter.content}</div>
                `;

                // Add event listener for the back button
                chapterContentEl.querySelector('.back-btn').addEventListener('click', () => renderTableOfContents());
            }

            /**
             * Checks if a chapter has NSFW content
             */
            function hasNsfwContent(chapter) {
                return chapter.tags && chapter.tags.some(tag => tag.toLowerCase() === 'nsfw');
            }

            /**
             * Handles chapter click with NSFW verification
             */
            function handleChapterClick(chapter) {
                if (hasNsfwContent(chapter) && !ageVerified) {
                    showAgeVerification(chapter);
                } else {
                    showChapter(chapter);
                }
            }

            /**
             * Renders the list of characters for the wiki.
             * Hides other views.
             */
            function showCharactersWiki() {
                chaptersListEl.style.display = 'none';
                chapterContentEl.style.display = 'none';
                characterContentEl.style.display = 'none';
                sortSelect.style.display = 'none'; // Sort select is only for chapters
                wikiListEl.style.display = 'block';

                mainTitleEl.textContent = 'Characters Wiki';
                currentView = 'wiki';

                if (characters.length === 0) {
                    wikiListEl.innerHTML = '<p class="character-description-summary">Loading characters...</p>';
                    fetch('wiki.json')
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            characters = data;
                            renderCharacterList();
                        })
                        .catch(err => {
                            wikiListEl.innerHTML = '<p class="character-description-summary">Failed to load characters wiki. Please ensure <code>wiki.json</code> exists and is correctly formatted.</p>';
                            console.error('Error loading wiki data:', err);
                        });
                } else {
                    renderCharacterList();
                }
            }

            /**
             * Renders the list of characters fetched from wiki.json.
             */
            function renderCharacterList() {
                wikiListEl.innerHTML = characters.map(character => {
                    const abilitiesHtml = character.abilities && character.abilities.length > 0
                        ? `<div class="character-tags">${character.abilities.map(ability => `<span class="tag">${ability}</span>`).join('')}</div>`
                        : '';
                    return `
                        <div class="character-summary" data-id="${character.id}">
                            <div class="character-name">${character.name}</div>
                            <div class="character-meta">
                                Age: ${character.age || 'N/A'} | 
                                Gender: ${character.genderPronouns || 'N/A'} | 
                                Occupation: ${character.occupation || 'N/A'}
                            </div>
                            ${abilitiesHtml}
                            <div class="character-description-summary">${character.backstoryShort || character.description.substring(0, 150) + '...'}</div>
                        </div>
                    `;
                }).join('');
            }

            /**
             * Displays the full details of a selected character.
             * Hides other views.
             * @param {Object} character - The character object to display.
             */
            function showCharacterDetails(character) {
                chaptersListEl.style.display = 'none';
                chapterContentEl.style.display = 'none';
                wikiListEl.style.display = 'none';
                sortSelect.style.display = 'none';
                characterContentEl.style.display = 'block';

                mainTitleEl.textContent = character.name;
                currentView = 'character-detail';

                const abilitiesHtml = character.abilities && character.abilities.length > 0
                    ? `<h3>Abilities:</h3><ul>${character.abilities.map(ability => `<li>${ability}</li>`).join('')}</ul>`
                    : '';
                const affiliationsHtml = character.affiliations && character.affiliations.length > 0
                    ? `<h3>Affiliations:</h3><ul>${character.affiliations.map(affiliation => `<li>${affiliation}</li>`).join('')}</ul>`
                    : '';

                characterContentEl.innerHTML = `
                    <div class="back-btn" data-target="wiki-list">
                        <i class="fas fa-arrow-left"></i>
                        Back to Characters Wiki
                    </div>
                    <h2 class="character-name" style="font-size: 2rem; margin-bottom: 0.5rem;">${character.name}</h2>
                    <div class="character-meta">
                        Age: ${character.age || 'N/A'} | 
                        Gender/Pronouns: ${character.genderPronouns || 'N/A'} | 
                        Sexuality: ${character.sexuality || 'N/A'} | 
                        Occupation: ${character.occupation || 'N/A'}
                    </div>
                    <div class="character-full-details">
                        <h3>Backstory:</h3>
                        <p>${character.backstoryShort || 'No short backstory provided.'}</p>
                        <h3>Description:</h3>
                        <p>${character.description || 'No description provided.'}</p>
                        ${abilitiesHtml}
                        ${affiliationsHtml}
                        <p><strong>First Appearance:</strong> ${character.firstAppearance || 'N/A'}</p>
                    </div>
                `;

                // Add event listener for the back button
                characterContentEl.querySelector('.back-btn').addEventListener('click', () => showCharactersWiki());
            }


            // Age verification event listeners
            ageConfirm.addEventListener('click', () => {
                ageVerified = true;
                hideAgeVerification();
                if (pendingNsfwChapter) {
                    showChapter(pendingNsfwChapter);
                }
            });

            ageDecline.addEventListener('click', () => {
                hideAgeVerification();
                // Could show a message or redirect if needed
            });

            // Load chapters from book.json file
            fetch('book.json')
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    chapters = data;
                    sortChapters(); // Initial sort and render
                })
                .catch(err => {
                    chaptersListEl.innerHTML = '<p class="chapter-content-summary">Failed to load book chapters. Please ensure <code>book.json</code> exists and is correctly formatted.</p>';
                    console.error('Error loading book data:', err);
                });

            // Event listeners for chapters
            chaptersListEl.addEventListener('click', e => {
                const chapterElement = e.target.closest('.chapter-summary');
                if (chapterElement) {
                    const chapterId = chapterElement.dataset.id;
                    const chapter = chapters.find(c => c.id === chapterId);
                    if (chapter) {
                        handleChapterClick(chapter);
                    }
                }
            });

            // Event listener for characters wiki list
            wikiListEl.addEventListener('click', e => {
                const characterElement = e.target.closest('.character-summary');
                if (characterElement) {
                    const characterId = characterElement.dataset.id;
                    const character = characters.find(c => c.id === characterId);
                    if (character) {
                        showCharacterDetails(character);
                    }
                }
            });

            // Navigation links
            homeLinkEl.addEventListener('click', (e) => {
                e.preventDefault();
                renderTableOfContents();
            });

            wikiLinkEl.addEventListener('click', (e) => {
                e.preventDefault();
                showCharactersWiki();
            });

            sortSelect.addEventListener('change', sortChapters);

            // Close modal when clicking outside
            ageModal.addEventListener('click', (e) => {
                if (e.target === ageModal) {
                    hideAgeVerification();
                }
            });
        </script>
    </div>
</body>
</html>
